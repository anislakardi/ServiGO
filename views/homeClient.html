<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ServiGO - Accueil</title>
  <link rel="stylesheet" href="../style/homeClient.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body onload="loadAllPublications()">
  <!-- Navbar -->
  <nav>
    <div class="logo">
      <h1>ServiGO</h1>
    </div>
    <ul>
      <li><a id="active">Accueil</a></li>
      <li><a href="../../views/offreurs.html">Offreurs</a></li>
      <li><a href="../../views/messagerie.html">Messagerie</a></li>
      <li><a href="notification.html">Notifications</a></li>
      <li><a href="../../views/profileClient.html">Profile</a></li>
      <li class="dropdown">
        <a href="#options">Options <i class="fas fa-chevron-down"></i></a>
        <div class="dropdown-content">
          <a href="../../views/avisServiGO.html"><i class="fas fa-bell"></i> Avis ServiGO</a>
          <a onclick="logout()"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
        </div>
      </li>
    </ul>
  </nav>

  <!-- Contenu principal -->
  <main>
    <div class="main-header">
      <h2>Bienvenue sur ServiGO</h2>
      <p>Découvrez et partagez vos besoins en services avec la communauté</p>
    </div>

    <div class="action-buttons">
      <button id="openDialogBtn" class="create-btn">
        <i class="fas fa-plus-circle"></i> Créer une Publication
      </button>
      <button id="openMyPostsBtn" class="my-posts-btn">
        <i class="fas fa-list"></i> Mes Publications
      </button>
    </div>


    <!-- Dialogue pour créer une publication -->
    <dialog id="publicationDialog">
      <div class="dialog-header">
        <h3>Nouvelle Publication</h3>
        <button onclick="document.getElementById('publicationDialog').close()">X</button>
      </div>
      <form id="publicationForm" class="register-form">
        <label for="titre">Titre</label>
        <input type="text" id="titre" name="titre" required />

        <label for="description">Description</label>
        <textarea id="description" name="description" rows="4" required></textarea>

        <label for="editBudget">Budget (en DZD)</label>
        <input type="number" id="budget" name="budget" min="0" step="0.50">

        <label for="date_execution">Date d'exécution</label>
        <input type="datetime-local" id="date_execution" name="date_execution" />

        <label for="service_vise">Service visé</label>
        <select id="service_vise" name="service_vise">
          <option value="Mecanique automobile">Mécanique automobile</option>
          <option value="Electricite">Électricité</option>
          <option value="Menuiserie">Menuiserie</option>
          <option value="Maconnerie">Maçonnerie</option>
          <option value="Reparation electromenager">Réparation électroménager</option>
          <option value="Peinture et decoration">Peinture et décoration</option>
          <option value="Nettoyage">Nettoyage</option>
          <option value="Ferblanterie">Ferblanterie</option>
          <option value="Architecture">Architecture</option>
          <option value="Plomberie">Plomberie</option>
          <option value="Jardinier">Jardinier</option>
          <option value="Demenageur">Déménageur</option>
        </select>

        <div class="p-4 max-w-md mx-auto">
          <label for="wilaya">Wilaya</label>
          <select id="wilaya" name="wilaya" class="w-full p-2 border rounded">
            <option value="">-- Sélectionnez une wilaya --</option>
          </select>
      
          <label for="commune" class="mt-4 block">Commune</label>
          <select id="commune" name="commune" class="w-full p-2 border rounded">
            <option value="">-- Sélectionnez une commune --</option>
          </select>
        </div>

        <label for="media">Média</label>
        <input type="file" id="media" name="media" accept="image/*" />

        <button type="submit" id="submitPublicationBtn">Publier</button>
      </form>
    </dialog>

    <dialog id="myPostsDialog">
      <div class="dialog-header">
        <h3>Mes Annonces</h3>
        <button onclick="document.getElementById('myPostsDialog').close()">X</button>
      </div>
      <div class="my-posts-content" id="myPostsContainer">
        <!-- Les publications seront chargées dynamiquement ici -->
        <div class="loading-message">Chargement de vos publications...</div>
      </div>
    </dialog>

    <dialog id="editPublicationDialog">
      <div class="dialog-header">
        <h3>Modifications</h3>
        <button onclick="document.getElementById('editPublicationDialog').close()">X</button>
      </div>
      <div class="my-posts-content">
        <form id="editForm">
          <label for="editTitre">Titre</label>
          <input type="text" id="editTitre" name="titre">
      
          <label for="editDescription">Description</label>
          <textarea id="editDescription" name="description"></textarea>
      
          <label for="editDate">Date d'exécution</label>
          <input type="date" id="editDate" name="date">

          <label for="editBudget">Budget (en DZD)</label>
          <input type="number" id="editBudget" name="editBudget" min="0" step="0.01">
      
          <input type="hidden" id="editIndex" name="index">
      
          <button type="submit">Valider</button>
        </form>
        </div>
    </dialog>

    <dialog id="recommandationDialog">
      <div class="dialog-header">
        <h3>Recommander un prestataire</h3>
        <button onclick="document.getElementById('recommandationDialog').close()">X</button>
      </div>
      <form>
        <input type="text" id="searchInput" placeholder="Rechercher un prestataire..." />
    
        <ul id="prestataireList">
          
        </ul>
        <!-- Dans ton <dialog id="recommandationDialog"> -->
        <textarea id="commentaireInput" placeholder="Votre commentaire…" style="width:100%; height: 70px; margin:8px 0;"></textarea>

        <div style="margin-top: 10px;">
          <button id="confirmerBtn" type="button">Confirmer</button>
          <button type="reset">Annuler</button>
        </div>
      </form>
    </dialog>
    <dialog id="reportDialog">
      <form id="signalementForm" method="dialog">
        <div class="dialog-header">
          <h3>Signaler une publication</h3>
          <button type="button" onclick="document.getElementById('reportDialog').close()">X</button>
        </div>
    
        <div class="dialog-content">
          <p>Êtes-vous sûr de vouloir signaler cette publication ?</p>
          
          <!-- Ton formulaire ajouté ici -->
          <label for="signalementDescription">Description :</label><br><br>
          <textarea id="signalementDescription" rows="4" required></textarea>
        </div>
    
        <div class="dialog-actions">
          <button type="button" class="cancel-btn"
                  onclick="document.getElementById('reportDialog').close()">
            Annuler
          </button>
          <!-- Le bouton submit déclenche le submit du form -->
          <button type="submit" class="btn btn-signaler confirm-btn">
            Envoyer
          </button>
        </div>
      </form>
    </dialog>
    
    <!-- Nouveau dialogue pour afficher les recommandations reçues -->
    <dialog id="profilsRecommandedDialog">
      <div class="dialog-header">
        <h3><i class="fas fa-users"></i> Profils recommandés</h3>
        <button type="button" onclick="document.getElementById('profilsRecommandedDialog').close()">X</button>
      </div>
      <div class="dialog-content" id="recommandedProfilesContainer">
        <p class="loading-message"><i class="fas fa-spinner fa-pulse"></i> Chargement des recommandations...</p>
        <!-- Les profils recommandés seront chargés dynamiquement ici -->
      </div>
    </dialog>

    <!-- Publications -->
    <div class="publication-list" id="allPublicationsContainer">
      <!-- Les publications seront chargées dynamiquement ici -->
    </div>    
  </main>

  <footer style="text-align: center; padding: 30px; font-size: 14px; color: #666;">
    &copy; 2025 ServiGO. Tous droits réservés.
  </footer>

  
  <script src="../logout.js"></script>
  <script>
    // Attendre que le DOM soit complètement chargé
    document.addEventListener('DOMContentLoaded', function() {
    // Vérifier l'état de connexion
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    
    if (!token || !userId) {
      console.log('Utilisateur non connecté');
      // Rediriger vers la page de connexion si nécessaire
      // window.location.href = 'login.html';
    } else {
      console.log('Utilisateur connecté avec ID:', userId);
    }
    const signalementForm = document.getElementById('signalementForm');
      if (signalementForm) {
        signalementForm.addEventListener('submit', function(e) {
          e.preventDefault(); // Empêcher la fermeture automatique du dialogue
          window.confirmReport(); // Appeler la fonction confirmReport
        });
      }
    // Gestionnaire pour les liens de navigation
    document.querySelectorAll('nav ul li a').forEach(link => {
      link.addEventListener('click', function(e) {
        // Ne pas empêcher la navigation pour les liens normaux
        if (this.getAttribute('href').startsWith('#')) {
          e.preventDefault();
          return;
        }
        
        // Vérifier si l'utilisateur est connecté avant de naviguer
        if (!token || !userId) {
          e.preventDefault();
          alert('Vous devez être connecté pour accéder à cette page');
          window.location.href = 'login.html';
          return;
        }
        
        // Pour les liens de navigation normaux, laisser le comportement par défaut
        console.log('Navigation vers:', this.getAttribute('href'));
      });
    });
    
    const dialog = document.getElementById("publicationDialog");
    const myPostsDialog = document.getElementById("myPostsDialog");
    const recommandationDialog = document.getElementById("recommandationDialog");
    const profilsRecommandedDialog = document.getElementById("profilsRecommandedDialog");
    const openBtn = document.getElementById("openDialogBtn");
    const openMyPostsBtn = document.getElementById("openMyPostsBtn");
    const editPublicationDialog = document.getElementById("editPublicationDialog");
    const openRecommandationDialogBtn = document.querySelector(".openRecommandationDialogBtn");
    const searchInput = document.getElementById('searchInput');
    const prestataireList = document.getElementById('prestataireList');
    const confirmerBtn = document.getElementById('confirmerBtn');
    let currentReportedPublication = null;

    
    // DÉLÉGATION : capture tous les clics sur les boutons "Recommander"
document.addEventListener('click', async function(e) {
  const btn = e.target.closest('.openRecommandationDialogBtn');
  if (!btn) return;

  e.preventDefault();
  const clientId = localStorage.getItem('userId');
  const token    = localStorage.getItem('token');
  if (!clientId || !token) {
    return alert("Utilisateur non identifié");
  }
  

  try {
    const res = await fetch(`http://localhost:5001/api/demande/prestataires/client/${clientId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();

    // Remplissage du <ul>
    prestataireList.innerHTML = '';
    data.forEach(p => {
      const li = document.createElement('li');
      li.innerHTML = `
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" value="${p.prestataire_id}">
          ${p.prenom} ${p.nom}, ${p.specialisation}
        </label>
      `;
      prestataireList.appendChild(li);
    });

    // Reset filtre et ouverture du dialog
    searchInput.value = '';
    Array.from(prestataireList.children).forEach(li => li.style.display = '');
    // Quand tu ouvres ton dialog (dans la délégation click)
    // Récupère l'ID de la publication liée au bouton cliqué
    const publicationEl = btn.closest('.publication');
    const idPub        = publicationEl?.dataset?.id;
    recommandationDialog.dataset.publicationId = idPub;

    recommandationDialog.showModal();

  } catch (err) {
    console.error("Erreur chargement prestataires :", err);
    alert("Impossible de charger la liste des prestataires.");
  }
});


      if (openBtn) {
    openBtn.addEventListener("click", () => {
      dialog.showModal();
    });
      }
      
      if (openMyPostsBtn) {
    openMyPostsBtn.addEventListener("click", () => {
      myPostsDialog.showModal();
      loadUserPublications();
    });
      }


    // Sélectionner les publications et vérifier la présence de l'image
    document.querySelectorAll('.publication').forEach(publication => {
    const image = publication.querySelector('.publication-media');
    const text = publication.querySelector('.publication-text');

    // Vérifiez si l'image a une source valide
    if (image && image.src && image.src !== '' && image.alt.trim() !== '') {
      image.style.display = 'block';
        } else if (image) {
      image.style.display = 'none';
          if (text) {
            text.style.display = 'block';
          }
    }
    });

    let wilayas = [];
    let communes = [];

    // Charger les deux fichiers JSON
    Promise.all([
      fetch('../fichiers/Wilaya_Of_Algeria.json').then(res => res.json()),
      fetch('../fichiers/Commune_Of_Algeria.json').then(res => res.json())
    ]).then(([wilayaData, communeData]) => {
      wilayas = wilayaData;
      communes = communeData;

      populateWilayas(wilayas);
      }).catch(error => {
        console.error('Erreur lors du chargement des fichiers JSON:', error);
    });

    function populateWilayas(wilayas) {
      const wilayaSelect = document.getElementById('wilaya');
        if (!wilayaSelect) return;
        
      wilayas.forEach(w => {
        const option = document.createElement('option');
        option.value = w.id;
        option.textContent = w.name;
        wilayaSelect.appendChild(option);
      });

      // Écouteur pour changer les communes quand wilaya change
      wilayaSelect.addEventListener('change', () => {
        const selectedId = wilayaSelect.value;
        populateCommunes(selectedId);
      });
    }

    function populateCommunes(wilayaId) {
      const communeSelect = document.getElementById('commune');
        if (!communeSelect) return;
        
      communeSelect.innerHTML = '<option value="">-- Sélectionnez une commune --</option>';

      const filtered = communes.filter(c => c.wilaya_id === wilayaId);
      filtered.forEach(c => {
        const option = document.createElement('option');
        option.value = c.name;
        option.textContent = c.name;
        communeSelect.appendChild(option);
      });
    }

    let currentPost = null;

    // Fonction appelée au clic sur "Modifier"
    document.querySelectorAll('.edit-btn').forEach((btn, index) => {
      btn.addEventListener('click', () => {
        const publication = btn.closest('.publication');
        const titleElement = publication.querySelector('.publication-title');
        const descElement = publication.querySelector('.publication-text');
        const metaElement = publication.querySelector('.publication-header .meta:first-child');
        const budgetElement = publication.querySelector('.publication-budget');

        const title = titleElement ? titleElement.textContent.trim() : '';
        const desc = descElement ? descElement.textContent.trim() : '';
        const metaText = metaElement ? metaElement.innerText : '';
        const dateMatch = metaText.match(/Publié le\s*:\s*(\d{4}-\d{2}-\d{2})/);
        const date = dateMatch ? dateMatch[1] : '';
          const budget = budgetElement ? budgetElement.textContent.replace('Budget : ', '').replace(' DZD', '') : '';

        document.getElementById('editTitre').value = title;
        document.getElementById('editDescription').value = desc;
        document.getElementById('editDate').value = date;
        document.getElementById('editBudget').value = budget;
        document.getElementById('editIndex').value = index;

        editPublicationDialog.showModal();
      });
    });

    // Ajouter un événement pour fermer le dialog lorsqu'on clique sur X
      const closeEditDialogBtn = document.querySelector('#editPublicationDialog .dialog-header button');
      if (closeEditDialogBtn) {
        closeEditDialogBtn.addEventListener('click', function() {
      document.getElementById('editPublicationDialog').close();
    });
      }

    document.querySelectorAll('.delete-btn').forEach(button => {
      button.addEventListener('click', (e) => {
        const publication = e.target.closest('.publication');
        if (confirm("Es-tu sûr de vouloir supprimer cette publication ?")) {
          publication.remove();
        }
      });
    });

      if (searchInput && prestataireList) {
    searchInput.addEventListener('input', () => {
      const filter = searchInput.value.toLowerCase();
      const items = prestataireList.getElementsByTagName('li');
      Array.from(items).forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(filter) ? '' : 'none';
      });
    });
      }
  
      if (confirmerBtn) {
        confirmerBtn.addEventListener('click', async () => {
          // Récupère userId (recommandeur) et token
          const id_recommandeur = localStorage.getItem('userId');
          const token = localStorage.getItem('token');
          if (!id_recommandeur || !token) {
            return alert("Vous devez être connecté(e) pour recommander");
          }

          // Récupère l'ID de la publication sur laquelle on recommande
          // (Préalablement défini quand on ouvre le dialog)
          const id_publication = recommandationDialog.dataset.publicationId;
          if (!id_publication) {
            return alert("Aucune publication sélectionnée");
          }

          // Le commentaire saisi
          const commentaire = document.getElementById('commentaireInput').value.trim();

          // Les prestataires cochés
          const checkedBoxes = prestataireList.querySelectorAll('input[type="checkbox"]:checked');
          if (checkedBoxes.length === 0) {
            return alert("Sélectionnez au moins un prestataire");
          }

          try {
            // Pour chaque prestataire, envoie la recommandation
            for (const cb of checkedBoxes) {
              const id_profil_recommande = cb.value;
              const res = await fetch('http://localhost:5001/api/recommandations',
              {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  id_recommandeur,
                  id_publication,
                  id_profil_recommande,
                  commentaire
                })
              });
              console.log("Recommandation envoyée pour le prestataire ID:", res);
              if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.message || `Erreur ${res.status}`);
              }
            }

            alert("Recommandation(s) envoyée(s) avec succès !");
            recommandationDialog.close();
          } catch (err) {
            console.error("Erreur lors de l'envoi des recommandations :", err);
            alert("Impossible d'envoyer les recommandations : " + err.message);
          }
        });
      }

    // Gestion de la soumission du formulaire de publication
    const publicationForm = document.getElementById('publicationForm');
    if (publicationForm) {
      publicationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const mediaFile = document.getElementById('media').files[0];
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');
        
        if (!token || !userId) {
          alert('Vous devez être connecté pour créer une publication');
          return;
        }

        if (mediaFile) {
          compressImage(mediaFile, 800, 800, function(compressedBase64Data) {
            const data = {
              titre: document.getElementById('titre').value,
              description: document.getElementById('description').value,
              date_execution: document.getElementById('date_execution').value,
              service_vise: document.getElementById('service_vise').value,
              budget: document.getElementById('budget').value,
              adresse: `${document.getElementById('commune').value}, ${document.getElementById('wilaya').value}`,
              client_id: userId,
              media: compressedBase64Data
            };

            fetch('http://localhost:5001/api/publications', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(data)
            })
            .then(response => {
              if (response.ok) {
                alert('Publication créée avec succès !');
                document.getElementById('publicationDialog').close();
                window.location.reload();
              } else {
                throw new Error('Erreur lors de la création de la publication');
              }
            })
            .catch(error => {
              console.error('Erreur:', error);
              alert('Erreur lors de la création de la publication');
            });
          });
        } else {
          // Si pas d'image, envoyer sans media
          const data = {
            titre: document.getElementById('titre').value,
            description: document.getElementById('description').value,
            date_execution: document.getElementById('date_execution').value,
            service_vise: document.getElementById('service_vise').value,
            budget: document.getElementById('budget').value,
            adresse: `${document.getElementById('commune').value}, ${document.getElementById('wilaya').value}`,
            client_id: userId,
            media: null
          };

          fetch('http://localhost:5001/api/publications', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
          })
          .then(response => {
            if (response.ok) {
              alert('Publication créée avec succès !');
              document.getElementById('publicationDialog').close();
              window.location.reload();
            } else {
              throw new Error('Erreur lors de la création de la publication');
            }
          })
          .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la création de la publication');
          });
        }
      });
    }

    // Fonction pour charger les publications de l'utilisateur connecté
    async function loadUserPublications() {
      const myPostsContainer = document.querySelector('.my-posts-content');
        if (!myPostsContainer) return;
        
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');

      if (!token || !userId) {
        myPostsContainer.innerHTML = '<div class="error-message">Vous devez être connecté pour voir vos publications.</div>';
        return;
      }

      try {
        myPostsContainer.innerHTML = '<div class="loading-message">Chargement de vos publications...</div>';
        
        // Utiliser la bonne route API
        const response = await fetch(`http://localhost:5001/api/publications/client/${userId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la récupération des publications');
        }

        const publications = await response.json();
        
        if (publications.length === 0) {
          myPostsContainer.innerHTML = '<div class="no-posts-message">Vous n\'avez pas encore publié d\'annonces.</div>';
          return;
        }

        // Vider le conteneur
        myPostsContainer.innerHTML = '';
        
        // Ajouter chaque publication
        publications.forEach(publication => {
          const publicationElement = document.createElement('div');
          publicationElement.className = 'publication';
          publicationElement.dataset.id = publication.id;
          
          // Formater la date correctement
          let publishDate = '';
          let executionDate = '';

          try {
            if (publication.date_publication) {
              const dateP = new Date(publication.date_publication);
              if (!isNaN(dateP.getTime())) {
                const year = dateP.getFullYear();
                const month = String(dateP.getMonth() + 1).padStart(2, '0');
                const day = String(dateP.getDate()).padStart(2, '0');
                const hours = String(dateP.getHours()).padStart(2, '0');
                const minutes = String(dateP.getMinutes()).padStart(2, '0');
                publishDate = `${year}-${month}-${day} à ${hours}:${minutes}h`;
              }
            }

            if (publication.date_execution) {
              const dateE = new Date(publication.date_execution);
              if (!isNaN(dateE.getTime())) {
                const year = dateE.getFullYear();
                const month = String(dateE.getMonth() + 1).padStart(2, '0');
                const day = String(dateE.getDate()).padStart(2, '0');
                const hours = String(dateE.getHours()).padStart(2, '0');
                const minutes = String(dateE.getMinutes()).padStart(2, '0');
                executionDate = `${year}-${month}-${day} à ${hours}:${minutes}h`;
              }
            }
          } catch (error) {
            console.error('Erreur de formatage de date:', error);
          }
          
          publicationElement.innerHTML = `
            <div class="publication-header">
                <span class="meta">Publié le : ${publishDate} <br> Service : ${publication.service_vise}</span>
                <span class="meta">Exécution prévue : ${executionDate} <br> Adresse : ${publication.adresse}</span>
            </div>
            <h3 class="publication-title">${publication.titre}</h3>
            <p class="publication-text">${publication.description}</p>
            <p class="publication-budget">Budget : ${publication.budget ? publication.budget + ' DZD' : 'Non précisé'}</p>
            ${publication.media ? `
              <div class="publication-media-container">
                <img src="data:image/jpeg;base64,${publication.media}" 
                     alt="Image de la publication" 
                     class="publication-media" 
                     onload="this.style.display='block'; this.parentElement.style.display='flex';"
                     onerror="this.style.display='none'; this.parentElement.style.display='none';" />
              </div>
            ` : ''}
            <div class="publication-stats">
              <span>${publication.likes || 0} j'aimes</span> - <span>${publication.comments || 0} commentaires</span>
            </div>
            <div class="edit-delete-actions">
              <button class="edit-btn" onclick="editPublication(${publication.id})"><i class="fas fa-edit"></i> Modifier</button>
              <button class="delete-btn" onclick="deletePublication(${publication.id})"><i class="fas fa-trash"></i> Supprimer</button>
              <button class="view-recommended-profiles-btn" onclick="viewRecommendedProfiles(${publication.id})"><i class="fas fa-users"></i> Voir les recommandations</button>
            </div>
          `;
          
          myPostsContainer.appendChild(publicationElement);
        });

        // Ajouter des gestionnaires d'événements pour les boutons de recommandation
        document.querySelectorAll('.openRecommandationDialogBtn').forEach(button => {
          button.addEventListener('click', () => {
            if (recommandationDialog) {
              // Quand tu ouvres ton dialog (dans la délégation click)
              recommandationDialog.showModal();

              console.log("Dialogue de recommandation affiché.");
            }
          });
        });

        // Vérifier et corriger les images après leur chargement
        setTimeout(() => {
          document.querySelectorAll('.publication-media').forEach(img => {
            if (img.complete && img.naturalWidth === 0) {
              // L'image n'a pas pu être chargée
              img.style.display = 'none';
              img.parentElement.style.display = 'none';
            }
          });
        }, 500);

      } catch (error) {
        console.error('Erreur:', error);
        myPostsContainer.innerHTML = `<div class="error-message">Erreur lors du chargement de vos publications: ${error.message}</div>`;
      }
    }

    // Fonction pour modifier une publication
    window.editPublication = function(publicationId) {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Vous devez être connecté pour modifier une publication');
        return;
      }

      // Récupérer les détails de la publication
      fetch(`http://localhost:5001/api/publications/${publicationId}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Erreur lors de la récupération de la publication');
        }
        return response.json();
      })
      .then(publication => {
        // Remplir le formulaire d'édition
        document.getElementById('editTitre').value = publication.titre;
        document.getElementById('editDescription').value = publication.description;
        document.getElementById('editDate').value = publication.date_execution ? publication.date_execution.split('T')[0] : '';
        document.getElementById('editBudget').value = publication.budget;
        document.getElementById('editIndex').value = publicationId;
        
        // Ouvrir le dialogue d'édition
        document.getElementById('editPublicationDialog').showModal();
      })
      .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la récupération des détails de la publication');
      });
    };

    // Gestionnaire d'événements pour le formulaire d'édition
    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Vous devez être connecté pour modifier une publication');
        return;
      }

      const publicationId = document.getElementById('editIndex').value;
      const data = {
        titre: document.getElementById('editTitre').value,
        description: document.getElementById('editDescription').value,
        date_execution: document.getElementById('editDate').value,
        budget: document.getElementById('editBudget').value
      };

      fetch(`http://localhost:5001/api/publications/${publicationId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Erreur lors de la modification de la publication');
        }
        return response.json();
      })
      .then(result => {
        alert('Publication modifiée avec succès !');
        document.getElementById('editPublicationDialog').close();
        window.location.reload();
      })
      .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la modification de la publication');
      });
    });

    // Fonction pour supprimer une publication
    window.deletePublication = function(publicationId) {
      if (confirm('Êtes-vous sûr de vouloir supprimer cette publication ?')) {
        fetch(`http://localhost:5001/api/publications/${publicationId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
        .then(response => {
          if (response.ok) {
            // Supprimer l'élément du DOM
            const publicationElement = document.querySelector(`.publication[data-id="${publicationId}"]`);
            if (publicationElement) {
              publicationElement.remove();
            }
            alert('Publication supprimée avec succès');
          } else {
            throw new Error('Erreur lors de la suppression de la publication');
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert('Erreur lors de la suppression de la publication');
        });
      }
    };

    // Fonction pour ouvrir le dialogue de signalement
    

    // Fonction pour envoyer le signalement
    window.confirmReport = async function() {
      if (!window.currentReportedPublication) {
        return alert("Aucune publication sélectionnée à signaler");
      }

      // Récupère l'ID de la publication
      const publicationId = window.currentReportedPublication.dataset.id;
      // Récupère la description du formulaire
      const description = document
        .getElementById('signalementDescription')
        .value
        .trim();
      if (!description) {
        return alert("Merci de préciser un motif de signalement");
      }

      // Prépare le token
      const token = localStorage.getItem('token');
      if (!token) {
        return alert("Vous devez être connecté pour signaler");
      }

      try {
        console.log("Envoi du signalement pour la publication ID:", publicationId);
        
        // Envoi du signalement
        const response = await fetch('http://localhost:5001/api/signalements', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            type: 'publication',
            id_objet: publicationId,
            description: description,
            date_signalement: new Date().toISOString()
          })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.message || 'Erreur lors de l\'envoi du signalement');
        }

        // Feedback utilisateur
        alert("Signalement de la publication effectué avec succès !");
        document.getElementById('reportDialog').close();
        document.getElementById('signalementDescription').value = '';
        window.currentReportedPublication = null;

      } catch (error) {
        console.error('Erreur signalement :', error);
        alert("Erreur lors de l'envoi du signalement : " + error.message);
      }
    };

    // Fonction pour charger et afficher les profils recommandés pour une publication
    window.viewRecommendedProfiles = async function(publicationId) {
      const recommandedProfilesContainer = document.getElementById('recommandedProfilesContainer');
      const token = localStorage.getItem('token');
      
      if (!token) {
        recommandedProfilesContainer.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i> Vous devez être connecté pour voir les recommandations.</div>';
        return;
      }
      
      try {
        recommandedProfilesContainer.innerHTML = '<p class="loading-message"><i class="fas fa-spinner fa-pulse"></i> Chargement des recommandations...</p>';
        
        const response = await fetch(`http://localhost:5001/api/recommandations/publication/${publicationId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Erreur lors de la récupération des recommandations');
        }
        
        const recommandations = await response.json();
        if (recommandations.length === 0) {
          alert("Aucune recommandation trouvée pour cette publication.");
          return;
        }
        
        // Vider le conteneur
        recommandedProfilesContainer.innerHTML = '';
        
        // Ajouter chaque recommandation
        recommandations.forEach(recommandation => {
          const recommandationElement = document.createElement('div');
          recommandationElement.className = 'recommandation-item';
          
          // Formatage de la date si disponible
          let recommandationDate = '';
          try {
            if (recommandation.date_recommandation) {
              const date = new Date(recommandation.date_recommandation);
              if (!isNaN(date.getTime())) {
                recommandationDate = new Intl.DateTimeFormat('fr-FR', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                }).format(date);
              }
            }
          } catch (error) {
            console.error('Erreur de formatage de date:', error);
          }
          
          recommandationElement.innerHTML = `
            <div class="recommandation-header">
              <div class="user-info">
                <h4><i class="fas fa-user-check"></i> ${recommandation.nom || ''} ${recommandation.prenom}</h4>
                <span class="meta"><i class="far fa-calendar-alt"></i> Recommandé le : ${recommandationDate}</span>
                ${recommandation.adresse ? `<span class="meta"><i class="fas fa-home"></i> Adresse : ${recommandation.adresse}</span>` : ''}
              </div>
            </div><br>
            ${recommandation.commentaire ? `<p class="recommandation-comment"><i class="fas fa-quote-left"></i> ${recommandation.commentaire} <i class="fas fa-quote-right"></i></p>` : ''}
            <br>
            <div class="recommandation-actions">
              
              <button class="view-profile-btn"><i class="fas fa-user"></i> Voir profil</button>
            </div>
          `;
          
          recommandedProfilesContainer.appendChild(recommandationElement);
        });
        
        // Afficher le dialogue
        profilsRecommandedDialog.showModal();
        
      } catch (error) {
        console.error('Erreur:', error);
        recommandedProfilesContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Erreur lors du chargement des recommandations: ${error.message}</div>`;
      }
    };

    // Fonction pour charger toutes les publications
    window.loadAllPublications = async function() {
      try {
        const response = await fetch('http://localhost:5001/api/publications', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors du chargement des publications');
        }

        const publications = await response.json();

        const container = document.getElementById('allPublicationsContainer'); // ⚠️ cet ID doit exister dans ton HTML
          if (!container) {
            console.error("Conteneur de publications non trouvé");
            return;
          }
          
        container.innerHTML = '';

        publications.forEach(publication => {
          let publishDate = '';
          let executionDate = '';

          try {
            if (publication.date_publication) {
              const dateP = new Date(publication.date_publication);
              if (!isNaN(dateP.getTime())) {
                const year = dateP.getFullYear();
                const month = String(dateP.getMonth() + 1).padStart(2, '0');
                const day = String(dateP.getDate()).padStart(2, '0');
                const hours = String(dateP.getHours()).padStart(2, '0');
                const minutes = String(dateP.getMinutes()).padStart(2, '0');
                publishDate = `${year}-${month}-${day} à ${hours}:${minutes}h`;
              }
            }

            if (publication.date_execution) {
              const dateE = new Date(publication.date_execution);
              if (!isNaN(dateE.getTime())) {
                const year = dateE.getFullYear();
                const month = String(dateE.getMonth() + 1).padStart(2, '0');
                const day = String(dateE.getDate()).padStart(2, '0');
                const hours = String(dateE.getHours()).padStart(2, '0');
                const minutes = String(dateE.getMinutes()).padStart(2, '0');
                executionDate = `${year}-${month}-${day} à ${hours}:${minutes}h`;
              }
            }
          } catch (error) {
            console.error('Erreur de formatage de date:', error);
          }

          const div = document.createElement('div');
          div.className = 'publication';
          div.dataset.id = publication.id;
          div.innerHTML = `
            <div class="publication-header">
              <img src="${publication.photo_de_profil ? 'data:image/jpeg;base64,' + publication.photo_de_profil : '../style/images/plus-solid.svg'}" alt="Photo de profil" class="profile-pic">
              <div class="user-info">
                <h4 style="cursor:pointer;" onclick="window.location.href=(${publication.client_id} === ${localStorage.getItem('userId')} ? '../../views/profileClient.html' : 'views/profileClientVisitor.html?id=${publication.client_id}')">${publication.nom || 'Utilisateur'} ${publication.prenom || ''}</h4>
                <span class="meta">Publié le : ${publishDate} | Service : ${publication.service_vise}</span>
                <span class="meta">Exécution prévue : ${executionDate} | Adresse : ${publication.adresse}</span>
              </div>
            </div>
            <h3 class="publication-title">${publication.titre || 'Sans titre'}</h3>
            <p class="publication-text">${publication.description || 'Aucune description'}</p>
            <p class="publication-budget">Budget : ${publication.budget ? publication.budget + ' DZD' : 'Non précisé'}</p>
            ${publication.media ? `
              <div class="publication-media-container">
                <img src="data:image/jpeg;base64,${publication.media}" 
                     alt="Image de la publication" 
                     class="publication-media" 
                     onload="this.style.display='block'; this.parentElement.style.display='flex';"
                     onerror="this.style.display='none'; this.parentElement.style.display='none';" />
              </div>
            ` : ''}
            <div class="publication-stats">
              <span>${publication.likes || 0} j'aimes</span> - <span>${publication.comments || 0} commentaires</span>
            </div>
            <div class="publication-actions">
              <button><i class="fas fa-comment"></i> Commenter</button>
              <button><i class="fas fa-heart"></i> Aimer</button>
              <button class="openRecommandationDialogBtn"><i class="fa-solid fa-user"></i> Recommander</button>
              <button class="report-btn" onclick="openReportDialog(this)"><i class="fas fa-flag"></i> Signaler</button>
            </div>
          `;

          container.appendChild(div);
          
          // Vérifier si l'image a été chargée correctement
          const img = div.querySelector('.publication-media');
          if (img) {
            img.onload = function() {
              // L'image a été chargée avec succès
              this.style.display = 'block';
              this.parentElement.style.display = 'flex';
            };
            img.onerror = function() {
              // L'image n'a pas pu être chargée
              this.style.display = 'none';
              this.parentElement.style.display = 'none';
            };
          }
        });

        // Ajouter des gestionnaires d'événements pour les boutons de recommandation
        document.querySelectorAll('.openRecommandationDialogBtn').forEach(button => {
          button.addEventListener('click', () => {
            if (recommandationDialog) {
              // Quand tu ouvres ton dialog (dans la délégation click)
              recommandationDialog.showModal();

              console.log("Dialogue de recommandation affiché.");
            }
          });
        });

        // Vérifier et corriger les images après leur chargement
        setTimeout(() => {
          document.querySelectorAll('.publication-media').forEach(img => {
            if (img.complete && img.naturalWidth === 0) {
              // L'image n'a pas pu être chargée
              img.style.display = 'none';
              img.parentElement.style.display = 'none';
            }
          });
        }, 500);

      } catch (error) {
        console.error('Erreur lors du chargement des publications :', error);
      }
    };

    // Charger les publications au chargement de la page
    loadAllPublications();

    // Fonction pour gérer la navigation
    function navigateToPage(url) {
      // Vérifier si l'utilisateur est connecté
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');
      
      if (!token || !userId) {
        alert('Vous devez être connecté pour accéder à cette page');
        window.location.href = '/views/login.html';
        return;
      }
      
      // Rediriger vers la page demandée
      window.location.href = url;
    }
    
    // Ajouter des gestionnaires d'événements pour les liens de navigation
    document.querySelectorAll('nav ul li a').forEach(link => {
      const href = link.getAttribute('href');
      
      // Ignorer les liens avec des ancres (#)
      if (href && !href.startsWith('#')) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          navigateToPage(href);
        });
      }
    });

  });

  function openReportDialog(button) {
      window.currentReportedPublication = button.closest('.publication');
      if (!window.currentReportedPublication) {
        console.error("Impossible de trouver la publication à signaler");
        return;
      }
      document.getElementById('reportDialog').showModal();
    }

  function compressImage(file, maxWidth, maxHeight, callback) {
    const reader = new FileReader();

    reader.onload = function (event) {
        const img = new Image();
        img.onload = function () {
            const canvas = document.createElement("canvas");
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width *= maxHeight / height;
                    height = maxHeight;
                }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            const compressedBase64 = canvas.toDataURL("image/jpeg", 0.7); // compression
            const base64Data = compressedBase64.split(',')[1]; // 🔥 remove "data:image/jpeg;base64,"
            callback(base64Data);
        };
        img.src = event.target.result;
    };

    reader.readAsDataURL(file);
  }

  </script>
</body>
</html>
