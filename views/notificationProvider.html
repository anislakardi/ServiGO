<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ServiGO - Notifications</title>
  <link rel="stylesheet" href="../style/notificationProvider.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- NAVBAR -->
  <nav>
    <div class="logo">
      <h1>ServiGO</h1>
    </div>
    <ul>
      <li><a href="/homeProvider">Accueil</a></li>
      <li><a href="/demandes">Demandes</a></li>
      <li><a href="/messagerieProvider">Messagerie</a></li>
      <li><a id="active">Notifications</a></li>
      <li><a href="#">Options</a></li>
      <li><a href="/profileProvider">Profile</a></li>
    </ul>
  </nav>

  <!-- PAGE DE NOTIFICATIONS -->
  <main class="notifications-container">
    <div class="notifications-header">
      <h2>Notifications</h2>
      <button id="markAllRead" class="btn-mark-all">
        <i class="fas fa-check-double"></i>
        Tout marquer comme lu
      </button>
    </div>

    <div class="notifications-list">
      <!-- Les notifications seront chargées dynamiquement ici -->
    </div>

    <!-- Message quand il n'y a pas de notifications -->
    <div class="no-notifications" style="display: none;">
      <i class="fas fa-bell-slash"></i>
      <p>Aucune notification pour le moment</p>
    </div>
  </main>

  <script>
    // Fonction pour charger les notifications
    async function loadNotifications() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          throw new Error('Vous devez être connecté');
        }

        const response = await fetch('http://localhost:5001/api/notifications', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('Détails de l\'erreur:', errorData);
          throw new Error(`Erreur HTTP: ${response.status} - ${errorData.message || 'Erreur inconnue'}`);
        }

        const notifications = await response.json();
        const notificationsList = document.querySelector('.notifications-list');
        const noNotifications = document.querySelector('.no-notifications');

        // Vider la liste actuelle
        notificationsList.innerHTML = '';

        if (!notifications || notifications.length === 0) {
          noNotifications.style.display = 'flex';
          return;
        }

        noNotifications.style.display = 'none';

        // Afficher les notifications
        notifications.forEach(notification => {
          const notificationElement = document.createElement('div');
          notificationElement.className = `notification ${notification.est_lu ? 'read' : 'unread'}`;
          notificationElement.setAttribute('data-notification-id', notification.id);

          notificationElement.innerHTML = `
            <div class="notification-icon">
              <i class="fas ${getNotificationIcon(notification.type)}"></i>
            </div>
            <div class="notification-content">
              <h3>${notification.titre}</h3>
              <p>${notification.description}</p>
              <span class="notification-time">${formatDate(notification.date_creation)}</span>
            </div>
            <div class="notification-actions">
              ${!notification.est_lu ? `
                <button class="btn-mark-read" onclick="markAsRead(${notification.id})">
                  <i class="fas fa-check"></i>
                </button>
              ` : ''}
              <button class="btn-delete" onclick="deleteNotification(${notification.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;

          // Ajouter un gestionnaire de clic pour le lien
          if (notification.lien) {
            notificationElement.addEventListener('click', () => {
              window.location.href = notification.lien;
            });
          }

          notificationsList.appendChild(notificationElement);
        });

      } catch (error) {
        console.error('Erreur détaillée:', error);
        const notificationsList = document.querySelector('.notifications-list');
        notificationsList.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <p>Erreur lors du chargement des notifications</p>
            <p class="error-details">${error.message}</p>
            <button onclick="loadNotifications()" class="btn-retry">
              <i class="fas fa-sync-alt"></i> Réessayer
            </button>
          </div>
        `;
      }
    }

    // Fonction pour obtenir l'icône appropriée selon le type de notification
    function getNotificationIcon(type) {
      switch (type) {
        case 'message':
          return 'fa-envelope';
        case 'demande':
          return 'fa-handshake';
        case 'avis':
          return 'fa-star';
        case 'system':
          return 'fa-info-circle';
        default:
          return 'fa-bell';
      }
    }

    // Fonction pour formater la date
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;

      // Moins d'une minute
      if (diff < 60000) {
        return 'À l\'instant';
      }
      // Moins d'une heure
      if (diff < 3600000) {
        const minutes = Math.floor(diff / 60000);
        return `Il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
      }
      // Moins d'un jour
      if (diff < 86400000) {
        const hours = Math.floor(diff / 3600000);
        return `Il y a ${hours} heure${hours > 1 ? 's' : ''}`;
      }
      // Moins d'une semaine
      if (diff < 604800000) {
        const days = Math.floor(diff / 86400000);
        return `Il y a ${days} jour${days > 1 ? 's' : ''}`;
      }
      // Plus d'une semaine
      return date.toLocaleDateString('fr-FR', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
    }

    // Fonction pour marquer une notification comme lue
    async function markAsRead(notificationId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5001/api/notifications/${notificationId}/read`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }

        // Recharger les notifications
        await loadNotifications();
      } catch (error) {
        console.error('Erreur lors du marquage de la notification comme lue:', error);
        alert('Erreur lors du marquage de la notification comme lue');
      }
    }

    // Fonction pour marquer toutes les notifications comme lues
    async function markAllAsRead() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5001/api/notifications/read-all', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }

        // Recharger les notifications
        await loadNotifications();
      } catch (error) {
        console.error('Erreur lors du marquage de toutes les notifications comme lues:', error);
        alert('Erreur lors du marquage de toutes les notifications comme lues');
      }
    }

    // Fonction pour supprimer une notification
    async function deleteNotification(notificationId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5001/api/notifications/${notificationId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }

        // Recharger les notifications
        await loadNotifications();
      } catch (error) {
        console.error('Erreur lors de la suppression de la notification:', error);
        alert('Erreur lors de la suppression de la notification');
      }
    }

    // Charger les notifications au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
      loadNotifications();
      document.getElementById('markAllRead').addEventListener('click', markAllAsRead);
    });

    // Recharger les notifications toutes les 30 secondes
    setInterval(loadNotifications, 30000);
  </script>
</body>
</html> 