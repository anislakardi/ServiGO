<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ServiGO - Messagerie</title>
  <link rel="stylesheet" href="../style/messagerie.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav>
    <div class="logo">
      <h1>ServiGO</h1>
    </div>
    <ul>
      <li><a href="homeClient.html">Accueil</a></li>
      <li><a href="offreurs.html">Offreurs</a></li>
      <li><a id="active">Messagerie</a></li>
      <li><a href="notification.html">Notifications</a></li>
      <li><a href="profileClient.html">Profile</a></li>
      <li class="dropdown">
        <a href="#options">Options <i class="fas fa-chevron-down"></i></a>
        <div class="dropdown-content">
          <a href="avisServiGO.html"><i class="fas fa-bell"></i> Avis ServiGO</a>
          <a href="profileClient.html"><i class="fas fa-user"></i> Profil</a>
          <a href="#"><i class="fas fa-ellipsis-h"></i> Autre option</a>
        </div>
      </li>
    </ul>
  </nav>

  <!-- Zone de messagerie -->
  <main class="messagerie-container">
    <!-- Liste des conversations -->
    <div class="conversations-list">
      <div class="conversations">
        <!-- Les conversations seront chargées dynamiquement ici -->
      </div>
    </div>

    <!-- Zone de chat -->
    <div class="chat-area">
      <div class="chat-header">
        <h4 id="contact-name"></h4>
        <button id="edit-title-btn" class="edit-title-btn">
          <i class="fas fa-edit"></i>
        </button>
      </div>

      <div class="messages" id="messages-container">
        <!-- Les messages seront chargés dynamiquement ici -->
      </div>

      <div class="message-input">
        <label for="file-upload" class="file-label">
          <i class="fas fa-paperclip"></i>
        </label>
        <input type="file" id="file-upload" accept="image/*" style="display: none" />
        <input type="text" id="message-input" placeholder="Votre message..." />
        <button id="send-button"><i class="fas fa-paper-plane"></i></button>
      </div>      
    </div>
  </main>

  <!-- Modal pour le zoom d'image -->
  <div id="image-modal" class="image-modal">
    <span class="close-modal">&times;</span>
    <img id="modal-image" class="modal-content">
    <div id="modal-caption"></div>
  </div>

  <div id="signalementModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSignalementModal()">&times;</span>
      <h2>Signaler un message</h2>
      <form id="signalementForm">
        <label for="signalementDescription">Description :</label>
        <textarea id="signalementDescription" rows="4" required></textarea>
        <button type="submit" class="btn btn-signaler">Envoyer</button>
      </form>
    </div>
  </div>

  <script>
    // Récupérer l'ID du client connecté depuis le localStorage
    const clientId = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName') || '';
    const userFirstName = localStorage.getItem('userFirstName') || '';
    
    // Fonction pour charger les conversations avec leurs publications
    async function loadConversationsWithPublications() {
      try {
        const response = await fetch(`/api/conversation/client/${clientId}/publications`);
        
        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Erreur lors de la récupération des conversations');
        }
        
        const conversations = result.data;
        
        
        // Mettre à jour l'interface avec les conversations
        updateConversationsList(conversations);
      } catch (error) {
        
        // Afficher un message d'erreur à l'utilisateur
        const conversationsContainer = document.querySelector('.conversations');
        conversationsContainer.innerHTML = `
          <div class="error-message">
            <p>Impossible de charger les conversations. Veuillez réessayer plus tard.</p>
            <p>Erreur: ${error.message}</p>
          </div>
        `;
      }
    }

    // Fonction pour mettre à jour la liste des conversations
    function updateConversationsList(conversations) {
      const conversationsContainer = document.querySelector('.conversations');
      conversationsContainer.innerHTML = '';

      if (!conversations || conversations.length === 0) {
        conversationsContainer.innerHTML = `
          <div class="no-conversations">
            <p>Aucune conversation trouvée.</p>
          </div>
        `;
        return;
      }

      // Charger le dernier message pour chaque conversation
      conversations.forEach(async (conv) => {
        const conversationDiv = document.createElement('div');
        conversationDiv.className = 'conversation';
        conversationDiv.setAttribute('data-conversation-id', conv.id);
        
        // Utiliser le titre de la publication si disponible, sinon utiliser le titre de la conversation
        const title = conv.publication_titre || conv.titre || 'Conversation sans titre';
        
        // Afficher d'abord un message de chargement
        conversationDiv.innerHTML = `
          <div class="conversation-info">
            <h4>${title}</h4>
            <p class="last-message">Chargement du dernier message...</p>
          </div>
          <span class="message-time">${conv.date_execution ? new Date(conv.date_execution).toLocaleDateString() : 'Récent'}</span>
        `;

        // Ajouter l'élément à la liste avant de charger le dernier message
        conversationsContainer.appendChild(conversationDiv);

        // Charger le dernier message
        try {
          const response = await fetch(`/api/messages/${conv.id}`);
          if (response.ok) {
            const messages = await response.json();
            if (messages && messages.length > 0) {
              // Prendre le dernier message
              const lastMessage = messages[messages.length - 1];
              const lastMessageElement = conversationDiv.querySelector('.last-message');
              if (lastMessageElement) {
                lastMessageElement.textContent = lastMessage.description;
              }
        } else {
              const lastMessageElement = conversationDiv.querySelector('.last-message');
              if (lastMessageElement) {
                lastMessageElement.textContent = 'Aucun message';
              }
            }
          }
        } catch (error) {
          console.error('Erreur lors du chargement du dernier message:', error);
          const lastMessageElement = conversationDiv.querySelector('.last-message');
          if (lastMessageElement) {
            lastMessageElement.textContent = 'Erreur de chargement';
          }
        }

        conversationDiv.addEventListener('click', () => {
          // Gérer le clic sur la conversation
          handleConversationClick(conv);
        });
      });
    }

    // Fonction pour gérer le clic sur une conversation
    function handleConversationClick(conversation) {
      console.log('Clic sur la conversation:', conversation);
      // Mettre à jour le nom du contact
      document.getElementById('contact-name').textContent = conversation.publication_titre || conversation.titre || 'Conversation';
      
      // Marquer la conversation comme active
      document.querySelectorAll('.conversation').forEach(conv => {
        conv.classList.remove('active');
      });
      document.querySelector(`[data-conversation-id="${conversation.id}"]`).classList.add('active');
      
      // Charger les messages de la conversation
      loadMessages(conversation.id);
      
      // Ajouter l'ID de la conversation au bouton d'édition du titre
      document.getElementById('edit-title-btn').setAttribute('data-conversation-id', conversation.id);
    }

    // Fonction pour charger les messages d'une conversation
    async function loadMessages(conversationId) {
      try {
        console.log('Début du chargement des messages pour la conversation:', conversationId);
        const response = await fetch(`/api/messages/${conversationId}`);
        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const messages = await response.json();
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.innerHTML = '';

        if (!messages || messages.length === 0) {
          messagesContainer.innerHTML = `
            <div class="no-messages">
              <p>Aucun message dans cette conversation.</p>
            </div>
          `;
          return;
        }

        messages.forEach(message => {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${message.sender_client_id ? 'sent' : 'received'}`;

      let messageContent = `<p>${message.description || ''}</p>`;

      // Ajouter l'image si elle existe
      if (message.photos) {
        messageContent += `<img src="data:image/jpeg;base64,${message.photos}" alt="${message.description || ''}" />`;
      }

      messageDiv.innerHTML = `
        <div class="message-content">
          ${messageContent}
          <span class="message-time">${new Date(message.date_message).toLocaleTimeString()}</span>
          ${!message.sender_client_id ? `
            <div class="message-actions">
              <button class="message-menu-btn">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="message-menu">
                <button class="menu-item signal">
                  <i class="fas fa-flag"></i>
                  Signaler
                </button>
                <button class="menu-item copy">
                  <i class="fas fa-copy"></i>
                  Copier
                </button>
              </div>
            </div>
          ` : ''}
        </div>
      `;
       messageDiv.dataset.messageId = message.id;


      messagesContainer.appendChild(messageDiv);
    });


        // Faire défiler jusqu'au dernier message
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error('Erreur lors du chargement des messages:', error);
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.innerHTML = `
          <div class="error-message">
            <p>Impossible de charger les messages. Veuillez réessayer plus tard.</p>
            <p>Erreur: ${error.message}</p>
          </div>
        `;
      }
    }

    // Charger les conversations au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Page chargée, chargement des conversations...');
      if (!clientId) {
        console.error('Aucun ID client trouvé dans le localStorage');
        const conversationsContainer = document.querySelector('.conversations');
        conversationsContainer.innerHTML = `
          <div class="error-message">
            <p>Vous devez être connecté pour accéder à la messagerie.</p>
            <p><a href="login.html">Se connecter</a></p>
          </div>
        `;
        return;
      }
      loadConversationsWithPublications();
    });

    // Fonction pour compresser l'image
    function compressImage(file, maxWidth, maxHeight, callback) {
    const reader = new FileReader();

    reader.onload = function (event) {
        const img = new Image();
        img.onload = function () {
            const canvas = document.createElement("canvas");
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width *= maxHeight / height;
                    height = maxHeight;
                }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            const compressedBase64 = canvas.toDataURL("image/jpeg", 0.7); // compression
            const base64Data = compressedBase64.split(',')[1]; // 🔥 remove "data:image/jpeg;base64,"
            callback(base64Data);
        };
        img.src = event.target.result;
    };

    reader.readAsDataURL(file);
}

    // Gestion de l'envoi des messages
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const fileInput = document.getElementById('file-upload');
    let selectedFile = null;

    // Gestionnaire pour la sélection de fichier
    fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            selectedFile = file;
            
            // Afficher un indicateur que le fichier est sélectionné
            const fileLabel = document.querySelector('.file-label');
            fileLabel.title = `Fichier sélectionné: ${file.name}`;
            fileLabel.style.color = 'var(--Bright-Sun)';
        }
    });

    // Fonction pour envoyer un message
    async function sendMessage() {
        const message = messageInput.value.trim();
        const clientId = localStorage.getItem('userId');
        const activeConversation = document.querySelector('.conversation.active');
        
        if (!activeConversation) {
            alert('Veuillez sélectionner une conversation');
            return;
        }

        const conversationId = activeConversation.getAttribute('data-conversation-id');
        
        if (!message && !selectedFile) return;

        try {
            let messageData = {
                conversation_id: conversationId,
                sender_client_id: clientId,
                description: message,
                photos: null
            };

            if (selectedFile) {
                // Compresser l'image avant l'envoi
                compressImage(selectedFile, 800, 800, function(compressedBase64Data) {
                    messageData.photos = compressedBase64Data;
                    sendMessageToServer(messageData);
                });
    } else {
                sendMessageToServer(messageData);
            }
        } catch (error) {
            console.error('Erreur lors de l\'envoi du message:', error);
            alert('Erreur lors de l\'envoi du message. Veuillez réessayer.');
        }
    }

    // Fonction pour envoyer le message au serveur
    async function sendMessageToServer(messageData) {
        try {
            const response = await fetch('http://localhost:5001/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(messageData)
            });

            if (!response.ok) {
                throw new Error('Erreur lors de l\'envoi du message');
            }

            // Réinitialiser le formulaire
            messageInput.value = '';
            fileInput.value = '';
            selectedFile = null;
            
            // Réinitialiser l'indicateur de fichier
            const fileLabel = document.querySelector('.file-label');
            fileLabel.title = '';
            fileLabel.style.color = '';
            
            // Recharger les messages
            loadMessages(messageData.conversation_id);
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de l\'envoi du message. Veuillez réessayer.');
        }
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Gestion des menus de message
    document.addEventListener('click', (e) => {
        if (e.target.closest('.message-menu-btn')) {
            const menu = e.target.closest('.message-actions').querySelector('.message-menu');
            const allMenus = document.querySelectorAll('.message-menu');
            allMenus.forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            menu.classList.toggle('show');
        } else if (!e.target.closest('.message-menu')) {
            document.querySelectorAll('.message-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });

    // Gestion des actions du menu
    document.addEventListener('click', e => {
    if (e.target.closest('.menu-item.signal')) {
      // retire active de toute les autres bulles
      document.querySelectorAll('.message.active')
              .forEach(m => m.classList.remove('active'));

      // repère la bulle cliquée
      const msgEl = e.target.closest('.message');
      msgEl.classList.add('active');

      // ouvre la fenêtre
      document.getElementById('signalementDescription').value = '';
      document.getElementById('signalementModal').style.display = 'block';
    }
  });

    // Gestion de l'édition du titre de la conversation
    document.getElementById('edit-title-btn').addEventListener('click', async function() {
        const conversationId = this.getAttribute('data-conversation-id');
        if (!conversationId) {
            alert('Veuillez sélectionner une conversation');
            return;
        }
        
        const newTitle = prompt('Entrez le nouveau titre de la conversation:');
        if (!newTitle) return;
        
        try {
            const response = await fetch(`/api/conversation/titre/${conversationId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ titre: newTitle })
            });
            
            if (response.ok) {
                // Mettre à jour le titre dans l'interface
                document.getElementById('contact-name').textContent = newTitle;
                
                // Mettre à jour le titre dans la liste des conversations
                const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (conversationElement) {
                    const titleElement = conversationElement.querySelector('h4');
                    if (titleElement) {
                        titleElement.textContent = newTitle;
                    }
                }
                
                alert('Titre modifié avec succès');
    } else {
                throw new Error('Erreur lors de la modification du titre');
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de la modification du titre');
        }
    });

    // Fonction pour gérer le zoom des images
    function setupImageZoom() {
      const modal = document.getElementById('image-modal');
      const modalImg = document.getElementById('modal-image');
      const captionText = document.getElementById('modal-caption');
      const closeBtn = document.querySelector('.close-modal');

      // Ajouter l'événement de clic sur toutes les images des messages
      document.addEventListener('click', function(e) {
        if (e.target.tagName === 'IMG' && e.target.closest('.message')) {
          modal.classList.add('show');
          modalImg.src = e.target.src;
          captionText.innerHTML = e.target.alt;
        }
      });

      // Fermer la modal en cliquant sur le bouton de fermeture
      closeBtn.onclick = function() {
        modal.classList.remove('show');
      }

      // Fermer la modal en cliquant en dehors de l'image
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.classList.remove('show');
        }
      }

      // Réinitialiser le zoom lors de la fermeture
      closeBtn.addEventListener('click', function() {
        modalImg.style.transform = 'scale(1)';
      });
    }

    // Appeler la fonction de configuration du zoom après le chargement des messages
    const originalLoadMessages = loadMessages;
    loadMessages = async function(conversationId) {
      await originalLoadMessages(conversationId);
      setupImageZoom();
    };

    document.getElementById('signalementForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const description = document.getElementById('signalementDescription').value;
      const token = localStorage.getItem('token');
      const messageEl = document.querySelector('.message.active');
      if (!messageEl) {
        return alert('Aucun message sélectionné');
      }
      const messageId = messageEl.dataset.messageId;

      try {
        const response = await fetch('http://localhost:5001/api/signalements', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            type: 'Message',
            id_objet: messageId,
            description: description,
            date_signalement: new Date().toISOString()
          })
        });


        if (!response.ok) {
          throw new Error('Erreur lors de l\'envoi du signalement');
        }

        alert('Signalement envoyé avec succès');
        closeSignalementModal();
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'envoi du signalement');
      }
    });

    function closeSignalementModal() {
      document.getElementById('signalementModal').style.display = 'none';
    }
  </script>  
</body>
</html>
