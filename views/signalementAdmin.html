<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Signalements - Admin</title>
    <link rel="stylesheet" href="../style/signalementAdmin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navbar -->
    <nav>
        <div class="logo">
            <h1>ServiGO</h1>
        </div>
        <ul>
            <li><a href="admin-dashboard.html">Tableau de Bord</a></li>
            <li><a href="utilisateurAdmin.html">Utilisateurs</a></li>
            <li><a href="signalementAdmin.html" id="active">Signalements</a></li>
            <li><a href="login.html" class="logout-btn">Déconnexion</a></li>
        </ul>
    </nav>

    <main style="padding: 30px; width: 100%; max-width: 1000px; margin: 0 auto;">
        <div class="header">
            <h1>Gestion des Signalements</h1>
        </div>
        <div class="main-container">
        <div class="signalements-container">
            <div class="signalement-type">
                <h2><i class="fas fa-newspaper"></i> Signalements de Publications</h2>
                <div class="signalement-list" id="publication-signalements">
                    <!-- Les signalements de publications seront injectés ici par JavaScript -->
                </div>
            </div>
            
            <div class="signalement-type">
                <h2><i class="fas fa-user"></i> Signalements de Profils</h2>
                <div class="signalement-list" id="profil-signalements">
                    <!-- Les signalements de profils seront injectés ici par JavaScript -->
                </div>
            </div>
            
            <div class="signalement-type">
                <h2><i class="fas fa-comment"></i> Signalements de Messages</h2>
                <div class="signalement-list" id="message-signalements">
                    <!-- Les signalements de messages seront injectés ici par JavaScript -->
                </div>
            </div>            
        </div>
    </div>
    </main>

    <footer style="text-align: center; padding: 30px; font-size: 14px; color: #666;">
        &copy; 2025 ServiGO. Tous droits réservés.
    </footer>

    <!-- Modal -->
    <div id="signalementModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Signalement Détails</h2>
            <p><strong>Type:</strong> <span id="modal-type"></span></p>
            <p><strong>Statut:</strong> <span id="modal-statut"></span></p>
            <p><strong>Description:</strong> <span id="modal-description"></span></p>
            <p><strong>Date:</strong> <span id="modal-date"></span></p>
            <p><strong>Photo:</strong> 
                <span id="modal-picture">
                    <img id="modal-img" src="" alt="Image signalée" style="max-width: 100%; display: none;">
                </span>
            </p>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
    // Fonction pour récupérer les signalements par type
    function fetchSignalements(type) {
        fetch(`http://localhost:5001/api/signalements/type/${type}`)
            .then(response => response.json())
            .then(data => {
                let signalementContainer;
                signalementContainer = document.querySelector(`#${type}-signalements`);
                

                if (data && Array.isArray(data) && data.length > 0) { // Vérification si data est un tableau non vide
                    data.forEach(signalement => {
                        if (signalement) { // Vérifie que chaque signalement existe
                            const card = document.createElement('div');
                            card.classList.add('signalement-card');
                            console.log(signalement.id_objet); // Affiche le signalement dans la console pour le débogage
                            card.innerHTML = `
                                <div class="signalement-header">
                                    <span class="signalement-id">#${signalement.id}</span>
                                    <span class="signalement-date">${new Date(signalement.date_signalement).toLocaleDateString()}</span>
                                </div>
                                <div class="signalement-content">
                                    <p class="signalement-title"> ${ signalement.type === 'publication' ? 'Publication signalée' : 'Message signalé' }</p>

                                    <p class="signalement-description">${signalement.description || 'Aucune description disponible'}</p>
                                    <div class="signalement-actions">
                                        <button class="btn-view" data-id="${signalement.id}" data-id_objet="${signalement.id_objet}" data-type="${signalement.type}" data-description="${signalement.description || 'Aucune description disponible'}" data-date="${signalement.date_signalement}" data-statut="${signalement.statut}">Voir</button>
                                        <button class="btn-delete">Supprimer</button>
                                        <button class="btn-ignore" data-id="${signalement.id}">Ignorer</button>
                                    </div>
                                </div>
                            `;

                            signalementContainer.appendChild(card);
                        }
                    });
                    const ignoreBtns = document.querySelectorAll('.btn-ignore');
                    ignoreBtns.forEach(btn => {
                        btn.addEventListener('click', function () {
                            const card = btn.closest('.signalement-card');
                            const signalementId = card.querySelector('.btn-view').getAttribute('data-id');

                            fetch(`http://localhost:5001/api/signalements/${signalementId}`, {
                                method: 'DELETE'
                            })
                            .then(response => {
                                if (response.ok) {
                                    card.remove(); 
                                } else {
                                    alert('Erreur lors de la suppression du signalement.');
                                }
                            })
                            .catch(error => {
                                console.error('Erreur lors de la suppression:', error);
                            });
                        });
                    });

                    // Ajouter les événements de clic pour les boutons "Supprimer"
                    const deleteBtns = document.querySelectorAll('.btn-delete');
                    deleteBtns.forEach(btn => {
                        btn.addEventListener('click', function () {
                            const card = btn.closest('.signalement-card');
                            const viewBtn = card.querySelector('.btn-view');

                            const signalementId = viewBtn.getAttribute('data-id');
                            const objetId = viewBtn.getAttribute('data-id_objet');
                            const type = viewBtn.getAttribute('data-type');

                            let deleteUrl;
                            const confirmation = confirm(`Vous allez supprimer le signalement et le ${type} associé.`);
                            // Déterminer l'URL de suppression selon le type
                            if ( confirmation && type === 'publication') {
                                deleteUrl = `http://localhost:5001/api/publications/${objetId}`;
                            } else if ( confirmation && type === 'message') {
                                deleteUrl = `http://localhost:5001/api/messages/${objetId}`;
                            } else {
                                console.error('Type non pris en charge:', type);
                                return;
                            }

                            // Supprimer l'objet (publication/message/profil)
                            fetch(deleteUrl, {
                                method: 'DELETE'
                            })
                            .then(response => {
                                if (response.ok) {
                                    // Ensuite supprimer le signalement
                                    return fetch(`http://localhost:5001/api/signalements/${signalementId}`, {
                                        method: 'DELETE'
                                    });
                                } else {
                                    throw new Error('Erreur lors de la suppression du contenu signalé');
                                }
                            })
                            .then(response => {
                                if (response.ok) {
                                    card.remove(); // Supprimer la carte du DOM
                                } else {
                                    alert('Erreur lors de la suppression du signalement.');
                                }
                            })
                            .catch(error => {
                                console.error('Erreur lors de la suppression:', error);
                            });
                        });
                    });


                    // Ajouter les événements de clic pour les boutons "Voir" après l'ajout des signalements
                    const voirBtns = document.querySelectorAll('.btn-view');
                    voirBtns.forEach(btn => {
                        btn.addEventListener('click', function () {
                            const signalementId = btn.getAttribute('data-id_objet');
                            const type = btn.getAttribute('data-type');

                            if (type === 'publication') {
                                fetchPublicationDetails(signalementId);
                            } else if (type === 'message') {
                                fetchMessageDetails(parseInt(signalementId));
                            } else {
                                // Handle other types if necessary
                                modal.classList.add('show');
                            }
                        });
                    });
                } else {
                    signalementContainer.innerHTML = '<p>Aucun signalement trouvé.</p>';
                }
            })
            .catch(error => {
                console.error('Erreur lors de la récupération des signalements:', error);
                signalementContainer.innerHTML = '<p>Erreur lors de la récupération des signalements.</p>';
            });
    }
    
    function fetchSignalementsProfils() {
    Promise.all([
        fetch('http://localhost:5001/api/signalements/type/profile_client').then(r => r.json()),
        fetch('http://localhost:5001/api/signalements/type/profile_prestataire').then(r => r.json())
    ])
    .then(([clients, prestataires]) => {
        const clientsArray      = Array.isArray(clients)      ? clients      : [];
        const prestatairesArray = Array.isArray(prestataires) ? prestataires : [];
        const allProfiles = [...clientsArray, ...prestatairesArray];
        const container   = document.querySelector('#profil-signalements');
        container.innerHTML = '';

        if (allProfiles.length === 0) {
        container.innerHTML = '<p>Aucun signalement trouvé.</p>';
        return;
        }

        allProfiles.forEach(signalement => {
        const card = document.createElement('div');
        card.classList.add('signalement-card');
        card.innerHTML = `
            <div class="signalement-header">
            <span class="signalement-id">#${signalement.id}</span>
            <span class="signalement-date">${new Date(signalement.date_signalement).toLocaleDateString()}</span>
            </div>
            <div class="signalement-content">
            <p class="signalement-title">Profil signalé</p>
            <p class="signalement-description">${signalement.description || 'Aucune description disponible'}</p>
            <div class="signalement-actions">
                <button class="btn-view"
                        data-id="${signalement.id}"
                        data-id_objet="${signalement.id_objet}"
                        data-type="${signalement.type}"
                        data-description="${signalement.description || ''}"
                        data-date="${signalement.date_signalement}"
                        data-statut="${signalement.statut}">
                Voir
                </button>
                <button class="btn-suspend"
                        data-id="${signalement.id}"
                        data-id_objet="${signalement.id_objet}"
                        data-type="${signalement.type}">
                Suspendre
                </button>
                <button class="btn-ignore" data-id="${signalement.id}">Ignorer</button>
            </div>
            </div>
        `;
        container.appendChild(card);
        });

        // Listeners
        container.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', () => {
            const idObj = btn.dataset.id_objet;
            const type  = btn.dataset.type;

            if (type === 'publication') {
            fetchPublicationDetails(idObj);
            }
            else if (type === 'message') {
            fetchMessageDetails(+idObj);
            }
            else if (type === 'profile_client') {
            // rediriger vers la page client
            window.open(`profileClientVisitor.html?id=${idObj}`, '_blank');
            }
            else if (type === 'profile_prestataire') {
            // rediriger vers la page prestataire
            window.open(`profileClientVisitor.html?id=${idObj}`, '_blank');
            }
        });
        });


        container.querySelectorAll('.btn-suspend').forEach(btn => {
            btn.addEventListener('click', () => {
                const signalementId   = btn.dataset.id;        // id du signalement
                const idObj           = btn.dataset.id_objet;  // id du profil
                const type            = btn.dataset.type;      // "profile_client" ou "profile_prestataire"

                // 1) Demander la durée de suspension
                const input = prompt('Suspendre ce profil pour combien de jours ?');
                const jours_suspension = parseInt(input, 10);
                if (!jours_suspension || jours_suspension < 1) {
                alert('Nombre de jours invalide : opération annulée.');
                return;
                }

                // 2) Choisir l’URL de suspension
                const suspendUrl = type === 'profile_client'
                ? `http://localhost:5001/api/clients/${idObj}/suspendre`
                : `http://localhost:5001/api/prestataires/${idObj}/suspendre`;

                // 3) Appeler l’API de suspension
                fetch(suspendUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ jours_suspension })
                })
                .then(res => {
                if (!res.ok) throw new Error('Erreur suspension');
                // 4) Une fois suspendu, supprimer le signalement
                return fetch(`http://localhost:5001/api/signalements/${signalementId}`, { method: 'DELETE' });
                })
                .then(res => {
                if (!res.ok) throw new Error('Erreur suppression signalement');
                alert(`Profil suspendu pour ${jours_suspension} jours.`);
                // 5) Retirer la carte du DOM
                btn.closest('.signalement-card').remove();
                })
                .catch(err => {
                console.error(err);
                alert('Échec de la suspension ou de la suppression du signalement.');
                });
            });
            });



        container.querySelectorAll('.btn-ignore').forEach(btn => {
        btn.addEventListener('click', () => {
            const signalementId = btn.dataset.id;
            fetch(`http://localhost:5001/api/signalements/${signalementId}`, { method: 'DELETE' })
            .then(res => {
                if (res.ok) btn.closest('.signalement-card').remove();
                else throw new Error();
            })
            .catch(() => alert('Erreur lors de la suppression du signalement.'));
        });
        });
    })
    .catch(err => {
        console.error('Erreur lors de la récupération des signalements de profils :', err);
        document.querySelector('#profil-signalements').innerHTML = '<p>Erreur serveur.</p>';
    });
    }// Fonction pour récupérer le message spécifique en fonction de son ID
    function fetchMessageDetails(messageId) {
    fetch(`http://localhost:5001/api/message/${messageId}`)
        .then(response => response.json())
        .then(message => {
            if (message) {
                modalType.textContent = 'Message';
                modalDescription.textContent = message.description || 'Aucun contenu disponible';
                modalDate.textContent = new Date(message.date_message).toLocaleDateString();
                modalStatut.textContent = 'Active';

                const modalImg = document.getElementById('modal-img');
                if (message.photos) {
                    console.log('Image data received:', message.photos); // Debugging log
                    modalImg.src = `data:image/jpeg;base64,${message.photos}`;
                    modalImg.style.display = 'block';
                } else {
                    console.log('No image data available'); // Debugging log
                    modalImg.style.display = 'none';
                }

                modal.classList.add('show');
            } else {
                modalDescription.textContent = 'Message introuvable';
                modal.classList.add('show');
            }
        })
        .catch(error => {
            console.error('Erreur lors de la récupération du message:', error);
            modalDescription.textContent = 'Erreur lors de la récupération du message';
            modal.classList.add('show');
        });
}

// Function to fetch and display publication details
function fetchPublicationDetails(publicationId) {
    fetch(`http://localhost:5001/api/publications/${publicationId}`)
        .then(response => response.json())
        .then(publication => {
            if (publication) {
                modalType.textContent = 'Publication';
                modalDescription.textContent = publication.description || 'Aucune description disponible';
                modalDate.textContent = new Date(publication.date_publication).toLocaleDateString();
                modalStatut.textContent = publication.statut || 'Statut inconnu';

                const modalImg = document.getElementById('modal-img');
                if (publication.media) {
                    console.log('Publication media received:', publication.media); // Debugging log
                    modalImg.src = `data:image/jpeg;base64,${publication.media}`;
                    modalImg.style.display = 'block';
                } else {
                    console.log('No media available for publication'); // Debugging log
                    modalImg.style.display = 'none';
                }

                modal.classList.add('show');
            } else {
                modalDescription.textContent = 'Publication introuvable';
                modal.classList.add('show');
            }
        })
        .catch(error => {
            console.error('Erreur lors de la récupération de la publication:', error);
            modalDescription.textContent = 'Erreur lors de la récupération de la publication';
            modal.classList.add('show');
        });
}

    // Récupérer les signalements pour chaque type
    fetchSignalements('publication');
    fetchSignalementsProfils();       // remplace les deux appels séparés
    fetchSignalements('message');

    // Modal logic
    const modal = document.getElementById('signalementModal');
    const modalType = document.getElementById('modal-type');
    const modalDescription = document.getElementById('modal-description');
    const modalDate = document.getElementById('modal-date');
    const modalPicture = document.getElementById('modal-picture'); // Placeholder pour l'image
    const modalStatut = document.getElementById('modal-statut');
    const closeBtn = document.querySelector('.close-btn');

    // Fermer le modal lorsque l'utilisateur clique sur le bouton de fermeture
    closeBtn.addEventListener('click', function () {
        modal.classList.remove('show'); // Use class to hide modal
    });

    // Fermer le modal si l'utilisateur clique en dehors du modal
    window.addEventListener('click', function (event) {
        if (event.target === modal) {
            modal.classList.remove('show'); // Use class to hide modal
        }
    });

});



    </script>
    
</body>
</html>
