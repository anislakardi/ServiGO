<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ServiGO - Profil Prestataire</title>
  <link rel="stylesheet" href="../style/profileProviderView.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- PAGE PROFIL -->
  <main class="profile-container">
    <h1>Profile Visiteur</h1>

    <div class="profile-box" >
      <!-- Partie 1: Informations personnelles -->
      <div class="profile-header" id="profil-box">
        <div class="profile-pic-section">
          <div class="profile-pic-container">
            <img id="profileImage" src="../images/default-profile.png" alt=" ">
          </div>
        </div>
        <div class="profile-info">
          <h2 id="nom_utilisateur1">Mohammed Anis Lakardi</h2>
          <p class="specialty" id="nom_utilisateur1">Électricien professionnel</p>
          <p><i class="fas fa-envelope" id="nom_utilisateur1"></i> anis.lakardi@example.com</p>
          <p><i class="fas fa-phone"></i> +213 5 55 55 55 55</p>
          <p><i class="fas fa-map-marker-alt"></i> El Karimia, Chlef, Algérie</p>
          <div class="status-badge available">
            <i class="fas fa-circle"></i>
            <span id="statusText">Disponible</span>
          </div>
        </div>
        <div class="profile-actions">
          <button class="btn-message" onclick="redirectToMessagerie()">
            <i class="fas fa-envelope"></i>
            Message
          </button>
          <button class="btn-report" onclick="openReportModal()">
            <i class="fas fa-flag"></i>
            Signaler
          </button>
        </div>
      </div>

      <!-- Partie 2: Compétences 
      <div class="skills-section">
        <h3>Mes Compétences</h3>
        <div class="skills-list">
          <div class="skill-item">
            <span>Installation électrique</span>
            <span class="skill-level expert">Expert</span>
            <div class="verification-badge verified">
              <i class="fas fa-check-circle"></i>
              <span>Vérifié</span>
            </div>
            <button class="btn-delete-skill"><i class="fas fa-times"></i></button>
          </div>
          <div class="skill-item">
            <span>Dépannage électrique</span>
            <span class="skill-level expert">Expert</span>
            <div class="verification-badge pending">
              <i class="fas fa-clock"></i>
              <span>En attente</span>
            </div>
            <button class="btn-delete-skill"><i class="fas fa-times"></i></button>
          </div>
          <button class="btn-add-skill" onclick="openSkillModal()">
            <i class="fas fa-plus"></i> Ajouter une compétence
            <span class="verification-info">(Nouvelle compétence sera vérifiée)</span>
          </button>
        </div>
      </div> -->

      <!-- Partie 3: Mes services -->
      <div class="services-section">
        <div class="services-header">
          <h3>Mes services</h3>
          <div class="services-counter">
            <span class="current-count">0</span>
            <span class="max-count">/3</span>
            <span class="services-limit">Services maximum</span>
          </div>
        </div>
        <div class="services-gallery">
          <!-- Les services seront ajoutés dynamiquement ici -->
        </div>
      </div>

      <!-- Partie 4: Avis & Évaluations -->
      <div class="reviews-section">
        <h3>Avis & Évaluations</h3>
        <div class="rating-overview">
          <div class="average-rating">
            <span class="rating">4.7</span>
            <div class="stars">
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star-half-alt"></i>
            </div>
            <span class="total-reviews">(24 avis)</span>
          </div>
          <button class="btn btn-add-review" onclick="openReviewModal()">
            <i class="fas fa-plus"></i> Donner un avis
          </button>
        </div>
        <div class="reviews-list collapsed">
          <!-- Les avis seront ajoutés dynamiquement ici -->
        </div>
        <button class="toggle-reviews" onclick="toggleReviews()">
          <span>Voir plus avis</span>
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>

      <!-- Partie 6: Disponibilité -->
      <div class="availability-section">
        <div class="availability-status">
          <div class="working-hours">
            <h4>Horaires de travail</h4>
            <div class="schedule">
              <!-- Les horaires seront ajoutés dynamiquement ici -->
            </div>
          </div>
          <div class="status-toggle">
            <label class="switch">
              <input type="checkbox" checked disabled>
           
            </label>
           
          </div>
          
        </div>
      </div>

    
    </div>
  </main>

  <!-- MODAL d'édition -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Modifier mon profil</h2>
      <form class="edit-form">
        <div class="form-scroll">
          <!-- Informations personnelles -->
          <div class="form-section">
            <h3>Informations personnelles</h3>
            <label>Nom :</label>
            <input type="text" placeholder="Entrer le nom">

            <label>Prénom :</label>
            <input type="text" placeholder="Entrer le prénom">
            
            <label>Spécialité :</label>
            <input type="text" placeholder="Entrer votre spécialité">

            <label>Email :</label>
            <input type="email" placeholder="Entrer l'email">

            <label>Téléphone :</label>
            <input type="tel" placeholder="Entrer le numéro de téléphone">

            <label for="wilaya">Wilaya</label>
            <select id="wilaya" name="wilaya">
              <option value="">-- Sélectionnez une wilaya --</option>
            </select>

            <label for="commune">Commune</label>
            <select id="commune" name="commune">
              <option value="">-- Sélectionnez une commune --</option>
            </select>

            <label>Description :</label>
            <textarea placeholder="Décrivez-vous et vos services"></textarea>
          </div>

          <!-- Expérience et Formation -->
          <div class="form-section">
            <h3>Expérience et Formation</h3>
            <div class="experience-form">
              <h4>Formation</h4>
              <div class="education-item">
                <label>Diplôme :</label>
                <input type="text" placeholder="Ex: Diplôme d'électricien professionnel">
                
                <label>Année :</label>
                <input type="number" placeholder="Ex: 2018">
                
                <label>Établissement :</label>
                <input type="text" placeholder="Ex: Centre de formation professionnelle">
                
                <label>Ville :</label>
                <input type="text" placeholder="Ex: Chlef">
                
                <button type="button" class="btn btn-delete">Supprimer</button>
              </div>
              <button type="button" class="btn btn-add" onclick="addEducationItem()">+ Ajouter une formation</button>
            </div>

            <div class="experience-form">
              <h4>Expérience professionnelle</h4>
              <div class="experience-item">
                <label>Poste :</label>
                <input type="text" placeholder="Ex: Électricien indépendant">
                
                <label>Période :</label>
                <div class="date-range">
                  <input type="text" placeholder="Début (Ex: 2018)">
                  <span>à</span>
                  <input type="text" placeholder="Fin (Ex: présent)">
                </div>
                
                <label>Description :</label>
                <textarea placeholder="Décrivez votre expérience"></textarea>
                
                <button type="button" class="btn btn-delete">Supprimer</button>
              </div>
              <button type="button" class="btn btn-add" onclick="addExperienceItem()">+ Ajouter une expérience</button>
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-edit">Enregistrer</button>
      </form>
    </div>
  </div>

  <!-- Modal Ajout Compétence -->
  <div class="modal" id="skillModal">
    <div class="modal-content">
      <span class="close" onclick="closeSkillModal()">&times;</span>
      <h2>Ajouter une compétence</h2>
      <form class="skill-form">
        <label>Nom de la compétence :</label>
        <input type="text" placeholder="Entrer le nom de la compétence">
        
        <label>Niveau :</label>
        <select>
          <option value="debutant">Débutant</option>
          <option value="confirme">Confirmé</option>
          <option value="expert">Expert</option>
        </select>
        
        <button type="submit" class="btn btn-edit">Ajouter</button>
      </form>
    </div>
  </div>

  <!-- Modal Ajout Document -->
  <div class="modal" id="documentModal">
    <div class="modal-content">
      <span class="close" onclick="closeDocumentModal()">&times;</span>
      <h2>Ajouter un document</h2>
      <form class="document-form">
        <label>Type de document :</label>
        <select>
          <option value="cv">CV</option>
          <option value="diplome">Diplôme</option>
          <option value="certificat">Certificat</option>
          <option value="autre">Autre</option>
        </select>
        
        <label>Fichier :</label>
        <input type="file" accept=".pdf,.doc,.docx">
        
        <button type="submit" class="btn btn-edit">Ajouter</button>
      </form>
    </div>
  </div>

  <!-- Modal Service -->
  <div class="modal" id="addServiceModal">
    <div class="modal-content">
      <span class="close" onclick="closeAddServiceModal()">&times;</span>
      <h3>Ajouter un nouveau service</h3>
      
      <!-- Barre de progression -->
      <div class="form-progress">
        <div class="progress-bar">
          <div class="progress" id="formProgress"></div>
        </div>
        <div class="progress-text" id="progressText">0% complété</div>
      </div>

      <form id="addServiceForm" onsubmit="addNewService(event)">
        <!-- Informations générales -->
        <div class="form-section">
          <h3>Informations générales</h3>
          <div class="form-group">
            <label for="serviceTitle">Titre du service <span class="required">*</span></label>
            <input type="text" id="serviceTitle" required oninput="updateProgress()">
          </div>
          <div class="form-group">
            <label for="serviceCategory">Catégorie <span class="required">*</span></label>
            <select id="serviceCategory" required onchange="updateProgress()">
              <option value="">Sélectionnez une catégorie</option>
              <option value="plomberie">Plomberie</option>
              <option value="electricite">Électricité</option>
              <option value="menuisier">Menuiserie</option>
              <option value="macon">Maçonnerie</option>
              <option value="peinture">Peinture</option>
              <option value="nettoyage">Nettoyage</option>
              <option value="informatique">Informatique</option>
              <option value="jardinage">Jardinage</option>
            </select>
          </div>
          <div class="form-group">
            <label for="serviceDescription">Description détaillée <span class="required">*</span></label>
            <textarea id="serviceDescription" rows="4" required oninput="updateProgress()"></textarea>
          </div>
          <div class="form-group">
            <label for="serviceZone">Zone d'intervention <span class="required">*</span></label>
            <input type="text" id="serviceZone" required oninput="updateProgress()" placeholder="Ex: Alger Centre, Hydra, El Biar">
          </div>
        </div>

        <!-- Tarification -->
        <div class="form-section">
          <h3>Tarification</h3>
          <div class="form-group">
            <label for="servicePrice">Tarif (DA) <span class="required">*</span></label>
            <input type="number" id="servicePrice" required oninput="updateProgress()" placeholder="Ex: 5000">
          </div>
        </div>

        <!-- Médias -->
        <div class="form-section">
          <h3>Médias</h3>
          <div class="media-upload">
            <div class="upload-zone" onclick="document.getElementById('serviceImage').click()">
              <input type="file" id="serviceImage" accept="image/*" onchange="previewImage(this)">
              <i class="fas fa-image"></i>
              <span>Ajouter une image</span>
            </div>
            <div class="upload-zone" onclick="document.getElementById('serviceVideo').click()">
              <input type="file" id="serviceVideo" accept="video/*" onchange="previewVideo(this)">
              <i class="fas fa-video"></i>
              <span>Ajouter une vidéo</span>
            </div>
          </div>
          <div class="media-preview" id="mediaPreview"></div>
        </div>
        
        <!-- 4. Informations professionnelles -->
        <div class="form-section">
          <h3>4. Informations professionnelles</h3>
          <div class="form-group">
            <label>Expérience (en années)</label>
            <input type="number" placeholder="Ex: 5">
          </div>
          
          <div class="form-group">
            <label>Diplômes ou certifications</label>
            <input type="file" accept=".pdf,.doc,.docx">
          </div>
          
          <div class="form-group">
            <label>Assurance professionnelle</label>
            <div class="checkbox-group">
              <input type="checkbox" id="hasInsurance">
              <label for="hasInsurance">Oui, je suis assuré</label>
            </div>
          </div>
          
          <div class="form-group">
            <label>SIRET / N° registre de commerce</label>
            <input type="text" placeholder="Si auto-entrepreneur ou entreprise">
          </div>
        </div>


        <!-- Contact -->
        <div class="form-section">
          <h3>Contact</h3>
          <div class="form-group">
            <label for="servicePhone">Téléphone <span class="required">*</span></label>
            <input type="tel" id="servicePhone" required oninput="updateProgress()" placeholder="Ex: 0555 123 456">
          </div>
          <div class="form-group">
            <label for="serviceEmail">Email <span class="required">*</span></label>
            <input type="email" id="serviceEmail" required oninput="updateProgress()" placeholder="Ex: contact@example.com">
          </div>
        </div>
        
        <!-- 6. Paramètres personnalisés -->
        <div class="form-section">
          <h3>6. Paramètres personnalisés</h3>
          <div class="form-group">
            <label>Type de prestation</label>
            <div class="checkbox-group">
              <input type="checkbox" id="homeService">
              <label for="homeService">À domicile</label>
              <input type="checkbox" id="remoteService">
              <label for="remoteService">À distance</label>
              <input type="checkbox" id="siteService">
              <label for="siteService">Sur chantier</label>
            </div>
          </div>
          
          <div class="form-group">
            <label>Garantie offerte</label>
            <div class="checkbox-group">
              <input type="checkbox" id="hasWarranty">
              <label for="hasWarranty">Oui</label>
            </div>
            <textarea placeholder="Détails de la garantie" id="warrantyDetails"></textarea>
          </div>
          
          <div class="form-group">
            <label>FAQ personnalisée</label>
            <div class="faq-items">
              <div class="faq-item">
                <input type="text" placeholder="Question fréquente">
                <textarea placeholder="Réponse"></textarea>
                <button type="button" class="btn-delete" onclick="removeFaqItem(this)">Supprimer</button>
              </div>
            </div>
            <button type="button" class="btn-add" onclick="addFaqItem()">Ajouter une question</button>
          </div>
          
          <div class="form-group">
            <label>Services associés</label>
            <div class="related-services">
              <input type="text" placeholder="Ajouter un service associé">
              <button type="button" class="btn-add" onclick="addRelatedService()">+</button>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeAddServiceModal()">Annuler</button>
          <button type="submit" class="btn-primary">Publier le service</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Réponse -->
  <div class="modal" id="replyModal">
    <div class="modal-content">
      <span class="close" onclick="closeReplyModal()">&times;</span>
      <h2>Répondre à l'avis</h2>
      <form class="reply-form">
        <label>Votre réponse :</label>
        <textarea placeholder="Écrivez votre réponse ici..."></textarea>
        <button type="submit" class="btn btn-edit">Envoyer</button>
      </form>
    </div>
  </div>

  <!-- Modal Ajout Avis -->
  <div class="modal" id="reviewModal">
    <div class="modal-content">
      <span class="close" onclick="closeReviewModal()">&times;</span>
      <h2>Donner votre avis</h2>
      <form id="reviewForm" class="review-form">
        <div class="form-group">
          <div class="rating-container">
            <span class="rating-label">Évaluation</span>
            <div class="rating-stars">
              <input type="radio" id="star5" name="rating" value="5" required>
              <label for="star5" title="Excellent"><i class="fas fa-star"></i></label>
              <input type="radio" id="star4" name="rating" value="4">
              <label for="star4" title="Très bon"><i class="fas fa-star"></i></label>
              <input type="radio" id="star3" name="rating" value="3">
              <label for="star3" title="Bon"><i class="fas fa-star"></i></label>
              <input type="radio" id="star2" name="rating" value="2">
              <label for="star2" title="Moyen"><i class="fas fa-star"></i></label>
              <input type="radio" id="star1" name="rating" value="1">
              <label for="star1" title="Médiocre"><i class="fas fa-star"></i></label>
            </div>
            <div class="rating-description" id="ratingDescription">Sélectionnez une note</div>
          </div>
        </div>
        <div class="form-group">
          <label for="comment">Commentaire</label>
          <textarea id="comment" name="comment" rows="4" required 
                  placeholder="Partagez votre expérience avec ce prestataire..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeReviewModal()">Annuler</button>
          <button type="submit" class="btn btn-primary">Envoyer l'avis</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Fonction pour charger les informations du prestataire
    async function loadProfile() {
      try {
        const userId = localStorage.getItem("userId");
        const token = localStorage.getItem("token");
        const profileId = new URLSearchParams(window.location.search).get('id');

        if (!userId || !token) {
          console.error("ID utilisateur ou token manquant");
          return;
        }

        // Si on consulte un profil spécifique, utiliser cet ID, sinon utiliser l'ID de l'utilisateur connecté
        const targetId = profileId || userId;

        // Stocker l'ID du prestataire dans une variable globale
        window.currentPrestataireId = targetId;

        const response = await fetch(`http://localhost:5001/api/prestataires/${targetId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la récupération des données');
        }

        const prestataire = await response.json();

        // Mise à jour des informations personnelles
        document.getElementById('nom_utilisateur1').textContent = `${prestataire.nom} ${prestataire.prenom}`;
        document.querySelector('.specialty').textContent = prestataire.specialisation || 'Spécialité non définie';
        document.querySelector('.fa-envelope').nextSibling.textContent = prestataire.email;
        document.querySelector('.fa-phone').nextSibling.textContent = prestataire.telephone || '+213 5 55 55 55 55';
        document.querySelector('.fa-map-marker-alt').nextSibling.textContent = prestataire.adresse || 'Adresse non définie';
        
        // Mise à jour de la photo de profil si elle existe
        if (prestataire.photo_profil) {
          document.getElementById('profileImage').src = prestataire.photo_profil;
        }
        
        // Mise à jour de l'expérience
        if (prestataire.experience) {
          document.querySelector('.experience-item p').textContent = `${prestataire.experience} années d'expérience`;
        }

      } catch (error) {
        console.error("Erreur lors du chargement du profil:", error);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      const userId = localStorage.getItem("userId");

      if (!token || !userId) {
        window.location.href = '/login.html';
        return;
      }

      loadProfile();
      loadServicePhotos();
    });
  </script>
  <script>
    // Scripts pour la gestion des fonctionnalités
    function openModal() {
      document.getElementById('editModal').style.display = 'block';
      // Charger les données actuelles dans le formulaire
      loadFormData({
        nom: document.getElementById('nom_utilisateur1').textContent.split(' ')[0],
        prenom: document.getElementById('nom_utilisateur1').textContent.split(' ')[1],
        email: document.querySelector('.fa-envelope').nextSibling.textContent,
        adresse: document.querySelector('.fa-map-marker-alt').nextSibling.textContent,
        specialisation: document.querySelector('.specialty').textContent
      });
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    window.onclick = function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      });
    }

    // Gestion des wilayas et communes
    let wilayas = [];
    let communes = [];

    Promise.all([
      fetch('../fichiers/Wilaya_Of_Algeria.json').then(res => res.json()),
      fetch('../fichiers/Commune_Of_Algeria.json').then(res => res.json())
    ]).then(([wilayaData, communeData]) => {
      wilayas = wilayaData;
      communes = communeData;
      populateWilayas();
    });

    function populateWilayas() {
      const wilayaSelect = document.getElementById('wilaya');
      wilayas.forEach(w => {
        const option = document.createElement('option');
        option.value = w.id;
        option.textContent = w.name;
        wilayaSelect.appendChild(option);
      });

      wilayaSelect.addEventListener('change', () => {
        const selectedId = wilayaSelect.value;
        populateCommunes(selectedId);
      });
    }

    function populateCommunes(wilayaId) {
      const communeSelect = document.getElementById('commune');
      communeSelect.innerHTML = '<option value="">-- Sélectionnez une commune --</option>';
      const filtered = communes.filter(c => c.wilaya_id === wilayaId);
      filtered.forEach(c => {
        const option = document.createElement('option');
        option.value = c.name;
        option.textContent = c.name;
        communeSelect.appendChild(option);
      });
    }

    // Fonctions pour les modals
    function openSkillModal() {
      document.getElementById('skillModal').style.display = 'block';
    }

    function closeSkillModal() {
      document.getElementById('skillModal').style.display = 'none';
    }

    function openDocumentModal() {
      document.getElementById('documentModal').style.display = 'block';
    }

    function closeDocumentModal() {
      document.getElementById('documentModal').style.display = 'none';
    }

    function openAddServiceModal() {
      const currentCount = document.querySelector('.current-count');
      if (parseInt(currentCount.textContent) >= 3) {
        alert('Vous avez atteint la limite maximale de 3 services.');
        return;
      }
      document.getElementById('addServiceModal').style.display = 'block';
    }

    function closeAddServiceModal() {
      document.getElementById('addServiceModal').style.display = 'none';
      document.getElementById('mediaPreview').innerHTML = '';
    }

    function openReplyModal() {
      document.getElementById('replyModal').style.display = 'block';
    }

    function closeReplyModal() {
      document.getElementById('replyModal').style.display = 'none';
    }

    // Fonction pour charger le statut initial
    async function loadProviderStatus() {
      try {
        const userId = localStorage.getItem("userId");
        const token = localStorage.getItem("token");

        if (!userId || !token) {
          console.error("ID utilisateur ou token manquant");
          return;
        }

        const response = await fetch(`http://localhost:5001/api/prestataires/${userId}/status`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la récupération du statut');
        }

        const data = await response.json();
        const status = data.status || 'disponible';
        
        // Mettre à jour le toggle et l'affichage
        const toggle = document.querySelector('.switch input');
        toggle.checked = status === 'disponible';
        
        const statusBadge = document.querySelector('.status-badge');
        const statusText = document.getElementById('statusText');
        
        if (status === 'disponible') {
          statusBadge.classList.remove('unavailable');
          statusBadge.classList.add('available');
          statusText.textContent = 'Disponible';
        } else {
          statusBadge.classList.remove('available');
          statusBadge.classList.add('unavailable');
          statusText.textContent = 'Occupé';
        }

      } catch (error) {
        console.error("Erreur lors du chargement du statut:", error);
        // En cas d'erreur, définir un statut par défaut
        const toggle = document.querySelector('.switch input');
        toggle.checked = true;
        const statusBadge = document.querySelector('.status-badge');
        const statusText = document.getElementById('statusText');
        statusBadge.classList.remove('unavailable');
        statusBadge.classList.add('available');
        statusText.textContent = 'Disponible';
      }
    }

    // Charger le statut au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      loadProviderStatus();
    });

    // Fonction pour mettre à jour le statut
    async function updateProviderStatus(status) {
      try {
        const userId = localStorage.getItem("userId");
        const token = localStorage.getItem("token");

        if (!userId || !token) {
          console.error("ID utilisateur ou token manquant");
          return;
        }

        const response = await fetch(`http://localhost:5001/api/prestataires/${userId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: status })
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la mise à jour du statut');
        }

        // Mettre à jour l'affichage du statut
        const statusBadge = document.querySelector('.status-badge');
        const statusText = document.getElementById('statusText');
        
        if (status === 'disponible') {
          statusBadge.classList.remove('unavailable');
          statusBadge.classList.add('available');
          statusText.textContent = 'Disponible';
        } else {
          statusBadge.classList.remove('available');
          statusBadge.classList.add('unavailable');
          statusText.textContent = 'Occupé';
        }

      } catch (error) {
        console.error("Erreur lors de la mise à jour du statut:", error);
        alert("Une erreur est survenue lors de la mise à jour du statut");
      }
    }

    // Gestion du toggle de disponibilité
    const availabilityToggle = document.querySelector('.switch input');
    availabilityToggle.addEventListener('change', function() {
      const status = this.checked ? 'disponible' : 'occupé';
      updateProviderStatus(status);
    });

    // Fonction pour charger les photos de services
    async function loadServicePhotos() {
      try {
        const userId = localStorage.getItem("userId");
        const token = localStorage.getItem("token");

        const response = await fetch(`http://localhost:5001/api/prestataires/${userId}/service-photos`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Erreur lors de la récupération des photos');

        const data = await response.json();
        const gallery = document.querySelector('.services-gallery');

        // Supprimer anciens services
        document.querySelectorAll('.service-item').forEach(el => el.remove());

        let count = 0;
        Object.entries(data.servicePhotos).forEach(([key, item]) => {
          if (item.photo) {
            const serviceDiv = document.createElement('div');
            serviceDiv.className = 'service-item';
            serviceDiv.innerHTML = `
              <img src="${item.photo}" alt="Service" class="service-image">
            `;
            gallery.appendChild(serviceDiv);
            count++;
          }
        });

        document.querySelector('.current-count').textContent = count;

      } catch (err) {
        console.error("Erreur chargement services:", err);
      }
    }

    // Fonctions pour gérer le modal d'avis
    function openReviewModal() {
      document.getElementById('reviewModal').style.display = 'block';
    }

    function closeReviewModal() {
      document.getElementById('reviewModal').style.display = 'none';
      document.getElementById('reviewForm').reset();
    }

    // Gestion de la soumission du formulaire d'avis
    document.getElementById('reviewForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const userId = localStorage.getItem("userId");
        const token = localStorage.getItem("token");
        const prestataireId = window.currentPrestataireId;
        
        if (!userId || !token) {
          alert("Veuillez vous connecter pour donner un avis");
          return;
        }

        if (!prestataireId) {
          alert("Erreur: Impossible de trouver le prestataire");
          return;
        }

        const formData = {
          client_id: userId,
          prestataire_id: prestataireId,
          evaluation: document.querySelector('input[name="rating"]:checked').value,
          commentaire: document.getElementById('comment').value
        };

        console.log("Envoi de l'avis:", formData); // Pour le débogage

        const response = await fetch('http://localhost:5001/api/avis', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Erreur lors de l\'envoi de l\'avis');
        }

        const result = await response.json();
        console.log("Réponse du serveur:", result); // Pour le débogage

        alert('Votre avis a été envoyé avec succès !');
        closeReviewModal();
        // Recharger les avis pour afficher le nouveau
        loadReviews();

      } catch (error) {
        console.error("Erreur lors de l'envoi de l'avis:", error);
        alert("Une erreur est survenue lors de l'envoi de votre avis: " + error.message);
      }
    });

    // Fonction pour charger les avis
    async function loadReviews() {
      try {
        const prestataireId = window.currentPrestataireId;
        const token = localStorage.getItem("token");

        const response = await fetch(`http://localhost:5001/api/avis/prestataire/${prestataireId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la récupération des avis');
        }

        const avis = await response.json();
        
        // Calcul de la moyenne des évaluations
        const totalEvaluations = avis.reduce((sum, avis) => sum + parseInt(avis.evaluation), 0);
        const moyenne = avis.length > 0 ? (totalEvaluations / avis.length).toFixed(1) : "0.0";
        
        // Mise à jour de la note moyenne et du nombre total d'avis
        document.querySelector('.rating').textContent = moyenne;
        document.querySelector('.total-reviews').textContent = `(${avis.length} avis)`;

        // Mise à jour des étoiles de la note moyenne
        const starsContainer = document.querySelector('.stars');
        starsContainer.innerHTML = '';
        const fullStars = Math.floor(moyenne);
        const hasHalfStar = moyenne % 1 >= 0.5;

        for (let i = 0; i < 5; i++) {
          const star = document.createElement('i');
          if (i < fullStars) {
            star.className = 'fas fa-star';
          } else if (i === fullStars && hasHalfStar) {
            star.className = 'fas fa-star-half-alt';
          } else {
            star.className = 'far fa-star';
          }
          starsContainer.appendChild(star);
        }

        // Mise à jour de la liste des avis
        const reviewsList = document.querySelector('.reviews-list');
        reviewsList.innerHTML = '';

        avis.forEach(avis => {
          const reviewItem = document.createElement('div');
          reviewItem.className = 'review-item';
          reviewItem.innerHTML = `
            <div class="reviewer-info">
              <span>${avis.client_nom}</span>
            </div>
            <div class="review-content">
              <div class="review-rating">
                ${Array(5).fill().map((_, i) => `
                  <i class="fas fa-star${i < avis.evaluation ? '' : '-o'}"></i>
                `).join('')}
              </div>
              <p>${avis.commentaire}</p>
              <span class="review-date">${new Date(avis.date_creation).toLocaleDateString()}</span>
            </div>
          `;
          reviewsList.appendChild(reviewItem);
        });

        // Afficher le bouton "Voir plus" uniquement s'il y a plus de 3 avis
        const toggleButton = document.querySelector('.toggle-reviews');
        if (avis.length > 3) {
          toggleButton.style.display = 'flex';
        } else {
          toggleButton.style.display = 'none';
        }

      } catch (error) {
        console.error("Erreur lors du chargement des avis:", error);
        document.querySelector('.rating').textContent = "0.0";
        document.querySelector('.total-reviews').textContent = "(0 avis)";
        document.querySelector('.stars').innerHTML = '<i class="far fa-star"></i>'.repeat(5);
      }
    }

    // Charger les avis au chargement de la page
    document.addEventListener('DOMContentLoaded', loadReviews);

    // Gestion des descriptions de notation
    const ratingDescriptions = {
      1: "Médiocre - Expérience très décevante",
      2: "Moyen - Des améliorations sont nécessaires",
      3: "Bon - Service satisfaisant",
      4: "Très bon - Service de qualité",
      5: "Excellent - Service exceptionnel"
    };

    document.querySelectorAll('.rating-stars input').forEach(input => {
      input.addEventListener('change', function() {
        const rating = this.value;
        document.getElementById('ratingDescription').textContent = ratingDescriptions[rating];
      });

      input.addEventListener('mouseover', function() {
        const rating = this.value;
        document.getElementById('ratingDescription').textContent = ratingDescriptions[rating];
      });
    });

    // Réinitialiser la description quand on quitte le système de notation
    document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
      const selectedRating = document.querySelector('input[name="rating"]:checked');
      if (selectedRating) {
        document.getElementById('ratingDescription').textContent = ratingDescriptions[selectedRating.value];
      } else {
        document.getElementById('ratingDescription').textContent = "Sélectionnez une note";
      }
    });

    // Fonction pour charger les horaires de travail
    async function loadWorkingHours() {
      try {
        const prestataireId = window.currentPrestataireId;
        const token = localStorage.getItem("token");

        const response = await fetch(`http://localhost:5001/api/horaire/${prestataireId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la récupération des horaires');
        }

        const horaires = await response.json();
        updateScheduleDisplay(horaires);
      } catch (error) {
        console.error("Erreur lors du chargement des horaires:", error);
      }
    }

    // Fonction pour mettre à jour l'affichage des horaires
    function updateScheduleDisplay(horaires) {
      const schedule = document.querySelector('.schedule');
      schedule.innerHTML = '';

      horaires.forEach(horaire => {
        const daySchedule = document.createElement('div');
        daySchedule.className = 'day-schedule';
        
        let timeText = horaire.ferme ? 'Fermé' : `${horaire.heure_debut} - ${horaire.heure_fin}`;
        
        daySchedule.innerHTML = `
          <span>${horaire.jour_semaine}</span>
          <span class="${horaire.ferme ? 'closed-day' : 'open-day'}">${timeText}</span>
        `;
        
        schedule.appendChild(daySchedule);
      });
    }

    // Charger les horaires au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      loadWorkingHours();
    });

    // Fonction pour basculer l'affichage des avis
    function toggleReviews() {
      const reviewsList = document.querySelector('.reviews-list');
      const toggleButton = document.querySelector('.toggle-reviews');
      const icon = toggleButton.querySelector('i');
      const text = toggleButton.querySelector('span');

      if (reviewsList.classList.contains('expanded')) {
        reviewsList.classList.remove('expanded');
        reviewsList.classList.add('collapsed');
        icon.className = 'fas fa-chevron-down';
        text.textContent = 'Voir plus avis';
      } else {
        reviewsList.classList.remove('collapsed');
        reviewsList.classList.add('expanded');
        icon.className = 'fas fa-chevron-up';
        text.textContent = 'Voir moins avis';
      }
    }

    // Fonction pour rediriger vers la messagerie
    async function redirectToMessagerie() {
      try {
        const prestataireId = localStorage.getItem("userId");
        const clientId = localStorage.getItem("userId");
        const token = localStorage.getItem("token");

        if (!prestataireId || !clientId || !token) {
          alert("Vous devez être connecté pour envoyer un message");
          return;
        }

        // Créer une nouvelle conversation avec le prestataire
        const response = await fetch('http://localhost:5001/api/conversation', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            client_id: clientId,
            prestataire_id: prestataireId,
            titre: `Conversation avec prestataire ${prestataireId}`
          })
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la création de la conversation');
        }

        const result = await response.json();
        
        // Rediriger vers la page de messagerie avec l'ID de la conversation
        window.location.href = `messagerie.html?id=${result.conversation.id}`;
      } catch (error) {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de la création de la conversation');
      }
    }
  </script>

</body>
</html> 