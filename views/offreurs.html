<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ServiGO - Offreurs</title>
  <link rel="stylesheet" href="../style/offreurs.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
</head>
<body>

  <!-- Navbar -->
  <nav>
    <div class="logo">
      <h1>ServiGO</h1>
    </div>
    <ul>
      <li><a href="homeClient.html">Accueil</a></li>
      <li><a id="active">Offreurs</a></li>
      <li><a href="messagerie.html">Messagerie</a></li>
      <li><a href="notification.html">Notifications</a></li>
      <li><a href="profileClient.html">Profile</a></li>
      <li class="dropdown">
        <a href="#options">Options <i class="fas fa-chevron-down"></i></a>
        <div class="dropdown-content">
          <a href="avisServiGO.html"><i class="fas fa-bell"></i> Avis ServiGO</a>
          <a onclick="logout()"><i class="fas fa-sign-out-alt"></i> D√©connexion</a>
        </div>
      </li>
    </ul>
  </nav>

  <!-- Contenu -->
  <main class="offreurs-container">

    <!-- Recherche -->
    <div class="search-wrapper">
      <input type="text" placeholder="Rechercher un prestataire...">
      <span class="search-icon">üîç</span>
    </div>

    <!-- Exemple d'une section de service -->
    <!-- Tu colles ce bloc pour chaque service en changeant le nom + image -->

    <!-- M√©canique automobile -->
    <section class="service-section" data-service="M√©canique automobile">
      <div class="service-header">
        <h2>M√©canique automobile</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">

      </div>
    </section>

    <!-- Electricit√© -->
    <section class="service-section" data-service="Electricit√©">
      <div class="service-header">
        <h2>Electricit√©</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">

      </div>
    </section>

    <!-- Menuiserie -->
    <section class="service-section" data-service="Menuiserie">
      <div class="service-header">
        <h2>Menuiserie</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
      </div>
    </section>
    <!-- Ma√ßonnerie -->
    <section class="service-section" data-service="Ma√ßonnerie">
      <div class="service-header">
        <h2>Ma√ßonnerie</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
         
      </div>
    </section>
    <!-- R√©paration √©lectrom√©nager -->
    <section class="service-section" data-service="R√©paration √©lectrom√©nager">
      <div class="service-header">
        <h2>R√©paration √©lectrom√©nager</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
      </div>
    </section>
    <!-- Peinture et d√©coration -->
    <section class="service-section" data-service="Peinture et d√©coration">
      <div class="service-header">
        <h2>Peinture et d√©coration</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
      </div>
    </section>
    <!-- Nettoyage -->
    <section class="service-section" data-service="Nettoyage">
      <div class="service-header">
        <h2>Nettoyage</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
      </div>
    </section>
    <!-- Ferblanterie -->
    <section class="service-section" data-service="Ferblanterie">
      <div class="service-header">
        <h2>Ferblanterie</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
      </div>
    </section>
    <!-- Architecture -->
    <section class="service-section" data-service="Architecture">
      <div class="service-header">
        <h2>Architecture</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
      </div>
    </section>
    <!-- Plomberie -->
    <section class="service-section" data-service="Plomberie">
      <div class="service-header">
        <h2>Plomberie</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
      </div>
    </section>
    <!-- Jardinier -->
    <section class="service-section" data-service="Jardinier">
      <div class="service-header">
        <h2>Jardinier</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
      </div>
    </section>
    <!-- D√©m√©nageur -->
    <section class="service-section" data-service="D√©m√©nageur">
      <div class="service-header">
        <h2>D√©m√©nageur</h2>
        <div class="scroll-buttons">
          <button class="scroll-left"><i class="fas fa-chevron-left"></i></button>
          <button class="scroll-right"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="cards-container">
         
      </div>
    </section>
  </main>
  <script src="../logout.js"></script>
  <script>
    // 1. Attendre que tout le DOM soit charg√©
    document.addEventListener('DOMContentLoaded', () => {
      initScroll();
      chargerPrestataires();
      initSearch();
    });
  
    function initScroll() {
      document.querySelectorAll('.service-section').forEach(section => {
        const container = section.querySelector('.cards-container');
        section.querySelector('.scroll-left')
          .addEventListener('click', () => container.scrollBy({ left: -300, behavior: 'smooth' }));
        section.querySelector('.scroll-right')
          .addEventListener('click', () => container.scrollBy({ left:  300, behavior: 'smooth' }));
      });
    }
  
    function initSearch() {
      document.querySelector('.search-wrapper input')
        .addEventListener('input', e => {
          const term = e.target.value.toLowerCase();
          document.querySelectorAll('.offreur-card').forEach(card => {
            const name = card.querySelector('h3').textContent.toLowerCase();
            card.style.display = name.includes(term) ? '' : 'none';
          });
        });
    }
  
    async function chargerPrestataires() {
      try {
        const resp = await fetch('http://localhost:5001/api/prestataires');
        const data = await resp.json();
  
        // 2. D√©dup global par ID
        const prestataires = Array.from(
          new Map(data.map(p => [p.id, p])).values()
        );
        // 3. Pour ignorer les sections r√©p√©t√©es
        const processedSpecs = new Set();
  
        for (const section of document.querySelectorAll('.service-section')) {
          const h2        = section.querySelector('h2');
          const specKey   = h2?.textContent.trim().toLowerCase();
          const container = section.querySelector('.cards-container');
          if (!specKey || processedSpecs.has(specKey)) continue;
          processedSpecs.add(specKey);
  
          container.innerHTML = '';      // on vide
          const seenIds = new Set();     // on √©vite double insertion dans la m√™me section
  
          for (const prest of prestataires) {
            if (prest.specialisation.trim().toLowerCase() !== specKey) 
              continue;
            if (seenIds.has(prest.id)) 
              continue;
            seenIds.add(prest.id);
  
            // 4. R√©cup√©rer et formater la moyenne
            const mResp = await fetch(
              `http://localhost:5001/api/avis/moyenne/${prest.id}`
            );
            const { moyenne: avg } = await mResp.json();
            const moyenne = avg == null
              ? "Pas d'avis"
              : Number(avg).toFixed(1).replace('.', ',');
  
            // 5. G√©rer les images nulles
            const photoProfil = prest.photo_de_profil || '../style/images/defaults.jpg';
            const svc1        = prest.service1_photo    || '../style/images/defaults.jpg';
            const svc2        = prest.service2_photo    || '../style/images/defaults.jpg';
  
            // 6. √âtat dispo
            const isBusy       = prest.disponibilite === "occupe";
            const statutClasse = isBusy ? "status busy" : "status available";
            const statutTexte  = isBusy ? "‚õî Occup√©"    : "üìÖ Disponible";
  
            // 7. Cr√©ation de la carte
            const card = document.createElement('div');
            card.className = 'offreur-card';
            card.dataset.id = prest.id;
            card.innerHTML = `
              <div class="card-header">
                <img class="avatar" src="${photoProfil}" alt="Profil">
                <div>
                  <h3>${prest.nom} ${prest.prenom}</h3>
                  <div class="meta">
                    <span class="stars">‚≠ê ${moyenne}</span>
                    <span class="location">üìç ${prest.adresse}</span>
                    <span class="${statutClasse}">${statutTexte}</span>
                  </div>
                </div>
              </div>
              <div class="service-images">
                <img src="${svc1}" alt="Preview 1">
                <img src="${svc2}" alt="Preview 2">
              </div>
              <button class="profile-btn">PROFILE</button>
            `;
            container.appendChild(card);
          }
        }
      } catch (err) {
        console.error("Erreur lors du chargement des prestataires :", err);
      }
    }
  </script>
  
  

    
</body>
</html>
